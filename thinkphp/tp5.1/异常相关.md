# 自定义监控异常报错发送钉钉通知

> **不建议发送钉钉通知**

## 资料

| 名称                | 地址                                                         |
| ------------------- | ------------------------------------------------------------ |
| thinkphp5.1异常处理 | [link](https://www.kancloud.cn/manual/thinkphp5_1/354092)    |
| 网络博客            | [link](https://blog.csdn.net/haibo0668/article/details/125236649) |



## 代码示例

[**添加异常处理接管**](https://www.kancloud.cn/manual/thinkphp5_1/354092)

> 修改**config\app.php**文件

```php
 // 异常处理handle类 留空使用 \think\exception\Handle
   // 'exception_handle'       => '',   # 原来默认的是设置为空
    'exception_handle'       => '\\app\\common\\exception\\Http',  # 托管后的异常位置
```

**添加异常类处理**

```php
<?php


namespace app\common\exception;


use app\common\service\DingDingService;
use Exception;
use think\exception\Handle;

class Http extends Handle
{
    public function render(Exception $e)
    {
        $reqUrl = request()->domain() . request()->url();
        $data['content'] = [
                "当前环境:" => \env('APP_ENV') == 'dev' ? "测试或开发环境" : "线上环境",
                "报错行数:" => $e->getLine(),
                "报错代码位置:" => $e->getFile(),
                "报错原因:" => $e->getMessage(),
                //"报错具体原因:" => $e->getTraceAsString(),
                "报错请求地址:" => $reqUrl ?? "",
                "请求参数:" => !empty(request()->param()) ? request()->param() : [],
                "请求ip:" => request()->ip(),
                "请求终端:"=>request()->header('user-agent'),
                "请求时间:" => date('Y-m-d H:i:s'),
        ];
        DingDingService::sendNotice($data);//发送钉钉通知不推荐
        return parent::render($e); // TODO: Change the autogenerated stub
        
        # 推荐写入数据库
              //Log::error("系统级别异常记录日志:" . json_encode($except_data));
//            $sysInsertData = [
//                'level' => 'error',
//                'log' => $except_data
//            ];
//            SystemLogDao::create($sysInsertData);
    }
}
```

**定义钉钉通知**

**配置钉钉配置**

> 在**config\dingding.php** 中添加

```shell
<?php

return [
    //机器人配置
    'robot' => [
        'dd_bot_token' => "you_dingding_token",//钉钉token
        'dd_bot_secret' => "you_dingding_secret",//钉钉密钥
    ]
];
```

**服务类**

```shell
<?php


namespace app\common\service;


use think\facade\Log;

class DingDingService
{
    public static function sendNotice($data)
    {
        $url = config('dingding.robot.dd_bot_token');
        $time = time() * 1000;//毫秒级时间戳
        $secret = config('dingding.robot.dd_bot_secret');
        if (empty($url) || empty($secret)) return true;
        $sign = hash_hmac('sha256', $time . "\n" . $secret, $secret, true);
        $sign = base64_encode($sign);
        $sign = urlencode($sign);
        $content = $data['content'] ?? "";
        $msg = [
            'msgtype' => 'text',//这是文件发送类型，可以根据需求调整
            'text' => [
                'content' => $content,
            ],
        ];
        $url = "{$url}&timestamp={$time}&sign={$sign}";
        $res = self::request_by_curl($url, $msg);
        Log::info("异常报错通知:" . $res);
    }

    public static function request_by_curl($remote_server, $post_string)
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $remote_server);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json;charset=utf-8'));
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post_string));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        // 线下环境不用开启curl证书验证, 未调通情况可尝试添加该代码
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    }
}
```

## 测试异常

> 就举个简单的例子吧 除法计算**0**不能作为除数,所以随便找个控制方法里面打印个变量**任意值/0**

````shell
$result=10/0;
return $result;
````

**上诉做完之后直接就可以在钉钉群里看见报错的具体信息**

## 优化通知到系统mysql日志(推荐)

### 创建保存日志数据表

```sql
CREATE TABLE `pxs_system_log` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `level` varchar(255) DEFAULT NULL,
  `log` json DEFAULT NULL,
  `create_time` datetime DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `ip` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ROW_FORMAT=DYNAMIC COMMENT='系统异常日志记录:项目中不好捕捉的异常信息都可以通过这里查询 日志量太大记得清除此表';
```

### 对应代码

```php
        // 添加自定义异常处理机制
        if ($e instanceof \Exception) {
            $reqUrl = request()->domain() . request()->url();
            $except_data = [
                "当前环境:" => \env('APP_ENV') == 'dev' ? "测试或开发环境" : "线上环境",
                "报错行数:" => $e->getLine(),
                "报错代码位置:" => $e->getFile(),
                "报错原因:" => $e->getMessage(),
                //"报错具体原因:" => $e->getTraceAsString(),
                "报错请求地址:" => $reqUrl ?? "",
                "请求参数:" => !empty(request()->param()) ? request()->param() : [],
                "请求ip:" => request()->ip(),
                "请求时间:" => date('Y-m-d H:i:s')
            ];
            //Log::error("系统级别异常记录日志:" . json_encode($except_data));
            $sysInsertData = [
                'level' => 'error',
                'log' => $except_data
            ];
            SystemLogDao::create($sysInsertData);
        }
```

**dao业务逻辑**

```php
<?php


namespace app\common\dao;


use app\common\model\SystemLogModel;

class SystemLogDao
{
    public static function create($data)
    {
        $log_level = $data['level'] ?? "info";
        $log = $data['log'] ?? "";
        $systemLog = new SystemLogModel();
        $systemLog->level = $log_level;
        if (!empty($log)) $systemLog->log = json_encode($log);
        $systemLog->ip = request()->ip();
        return $systemLog->save();
    }
    
     /**
     * 自动创建报错异常  比如中间件中的抛出异常系统日志是无法接受的所以要在中间件 异常中调用 SystemLogDao::autoCreateError($e);
     * @param $exception
     * @return bool
     */
    public static function autoCreateError($exception)
    {
        $except_data = [
            "当前环境:" => \env('APP_ENV') == 'dev' ? "测试或开发环境" : "线上环境",
            "报错行数:" => $exception->getLine(),
            "报错代码位置:" => $exception->getFile(),
            "报错原因:" => $exception->getMessage(),
            //"报错具体原因:" => $e->getTraceAsString(),
            "报错请求地址:" => $reqUrl ?? "",
            "请求参数:" => !empty(request()->except("_user,_uuid,_org_main")) ? request()->except("_user,_uuid,_org_main") : [],
            "请求ip:" => request()->ip(),
            "请求终端:" => request()->header('user-agent'),
            "请求时间:" => date('Y-m-d H:i:s'),
        ];
        //Log::error("系统级别异常记录日志:" . json_encode($except_data));
        $sysInsertData = [
            'level' => 'error',
            'log' => $except_data
        ];
        return self::create($sysInsertData);
    }
}
```

