# 自定义监控异常报错发送钉钉通知

## 资料

| 名称                | 地址                                                      |
| ------------------- | --------------------------------------------------------- |
| thinkphp5.1异常处理 | [link](https://www.kancloud.cn/manual/thinkphp5_1/354092) |



## 代码示例

[**添加异常处理接管**](https://www.kancloud.cn/manual/thinkphp5_1/354092)

> 修改**config\app.php**文件

```php
 // 异常处理handle类 留空使用 \think\exception\Handle
   // 'exception_handle'       => '',   # 原来默认的是设置为空
    'exception_handle'       => '\\app\\common\\exception\\Http',  # 托管后的异常位置
```

**添加异常类处理**

```php
<?php


namespace app\common\exception;


use Exception;
use think\exception\Handle;

class Http extends Handle
{
    public function render(Exception $e)
    {
        $data['content'] = [
            "当前环境" => \env('APP_ENV') == 'dev' ? "测试或本地环境" : "线上环境",     //可以.env里面设置判断环境是线上还是测试
            "报错行数" => $e->getLine(),
            "报错代码位置" => $e->getFile(),
            "报错原因" => $e->getMessage(),
            "报错具体原因" => $e->getTraceAsString(),
             "报错时间" => date('Y-m-d H:i:s'),
        ];
        DingDingService::sendNotice($data);//发送钉钉通知
        
        return parent::render($e); // TODO: Change the autogenerated stub      默认返回给父类处理异常
    }
}
```

**定义钉钉通知**

**配置钉钉配置**

> 在**config\dingding.php** 中添加

```shell
<?php

return [
    //机器人配置
    'robot' => [
        'dd_bot_token' => "you_dingding_token",//钉钉token
        'dd_bot_secret' => "you_dingding_secret",//钉钉密钥
    ]
];
```

**服务类**

```shell
<?php


namespace app\common\service;


use think\facade\Log;

class DingDingService
{
    public static function sendNotice($data)
    {
        $url = config('dingding.robot.dd_bot_token');
        $time = time() * 1000;//毫秒级时间戳
        $secret = config('dingding.robot.dd_bot_secret');
        if (empty($url) || empty($secret)) return true;
        $sign = hash_hmac('sha256', $time . "\n" . $secret, $secret, true);
        $sign = base64_encode($sign);
        $sign = urlencode($sign);
        $content = $data['content'] ?? "";
        $msg = [
            'msgtype' => 'text',//这是文件发送类型，可以根据需求调整
            'text' => [
                'content' => $content,
            ],
        ];
        $url = "{$url}&timestamp={$time}&sign={$sign}";
        $res = self::request_by_curl($url, $msg);
        Log::info("异常报错通知:" . $res);
    }

    public static function request_by_curl($remote_server, $post_string)
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $remote_server);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json;charset=utf-8'));
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post_string));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        // 线下环境不用开启curl证书验证, 未调通情况可尝试添加该代码
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    }
}
```

## 测试异常

> 就举个简单的例子吧 除法计算**0**不能作为除数,所以随便找个控制方法里面打印个变量**任意值/0**

````shell
$result=10/0;
return $result;
````

**上诉做完之后直接就可以在钉钉群里看见报错的具体信息**