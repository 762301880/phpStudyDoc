#  资料

> 由于我们是个人开发者所以全程采用沙箱环境进行支付测试

| name                                                         | url                                                          |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 第三方博客                                                   | [链接](https://blog.csdn.net/jal517486222/article/details/82726491) |
| 第三方博客                                                   | [链接](https://blog.csdn.net/jartins/article/details/81115649) |
| 支付宝开放平台-沙箱测试地址                                  | [链接](https://open.alipay.com/platform/appDaily.htm?tab=info) |
| 支付宝支付文档,沙箱环境web支付[文档](https://opendocs.alipay.com/open/200/105311) | [链接](https://openhome.alipay.com/docCenter/docCenter.htm)\|[链接](https://opendocs.alipay.com/open/200/105311) |



## 下载php支付宝支付sdk

| name                                                         | url                                                          |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| **[网站链接](https://opendocs.alipay.com/open/270/106291/)** | **[网站链接](https://opendocs.alipay.com/open/270/106291/)** |
| **sdk[下载](https://gw.alipayobjects.com/os/bmw-prod/b946adec-ef8d-4c1b-9faf-3f20dbf318fa.zip)** | **sdk[下载](https://gw.alipayobjects.com/os/bmw-prod/b946adec-ef8d-4c1b-9faf-3f20dbf318fa.zip)** |

- 在对应的网页中下载php-sdk

![image-20210727081618143.png](https://i.loli.net/2021/07/27/rCT9pLSIkBn5gbt.png)



## 生成密匙

| name               | url                                                 |
| ------------------ | --------------------------------------------------- |
| 开发工具           | [link](https://opendocs.alipay.com/open/291/105971) |
| 支付宝在线生成密钥 | [link](https://miniu.alipay.com/keytool/create)     |

> 生成密钥说明
>
> 1. 密钥格式选择 PKCS1(非JAVA适用) 因为我们不是java程序
>
> 2. 将生成的应用公钥 放到沙箱环境的RSA2(SHA256)密钥(推荐)设置中用于得到**支付宝公钥**，
>
>    记得保存好自己生成的私钥

## 沙箱账号

> 首先下载[支付宝钱包](https://sandbox.alipaydev.com/user/downloadApp.htm)用于支付
>
> 下载完成之后找到[沙箱账号](https://openhome.alipay.com/platform/appDaily.htm?tab=account)

![1627356356(1).jpg](https://i.loli.net/2021/07/27/aQ6KEnoZ3cdhXkF.png)

# 使用第三方composer[集成支付宝支付](https://laravelacademy.org/post/7804)

## 资料

| name                                                         | url                                                          |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [yansongda/](https://packagist.org/packages/yansongda/)pay(packagistlist地址-底层包) | [link](https://packagist.org/packages/yansongda/pay)         |
| [yansongda/](https://packagist.org/packages/yansongda/)laravel-pay(laravel专用) | [link](https://packagist.org/packages/yansongda/laravel-pay) |
| yansongda/pay详细文档                                        | [link](https://pay.yansongda.cn/docs/v3)                     |

#### [yansongda/laravel-*pay*](https://packagist.org/packages/yansongda/laravel-pay)使用

>[yansongda/](https://packagist.org/packages/yansongda/)pay集成了支付宝&微信支付我们开箱即用即可

#### 使用composer安装

```php
composer require yansongda/laravel-pay
```

- laravel 5.5 以下配置

```php
# 添加 service provider（optional）
// laravel < 5.5
Yansongda\LaravelPay\PayServiceProvider::class,
# 添加 alias（optional）
'Pay' => Yansongda\LaravelPay\Facades\Pay::class,
```

- 发布配置文件

```php
php artisan vendor:publish --provider="Yansongda\LaravelPay\PayServiceProvider" --tag=laravel-pay
```

- config\pay配置说明

```php
<?php

declare(strict_types=1);

use Yansongda\Pay\Pay;

return [
    'alipay' => [
        'default' => [
            // 支付宝分配的 app_id
            'app_id' => '2021000117694612',
            // 应用私钥
            'app_secret_cert' => '',#字符串格式
            // 应用公钥证书 路径
            'app_public_cert_path' => public_path('/rsa/appCertPublicKey_2021000117694612.crt'),# 地址
            // 支付宝公钥证书 路径
            'alipay_public_cert_path' => public_path('/rsa/alipayCertPublicKey_RSA2.crt'),# 地址
            // 支付宝根证书 路径
            'alipay_root_cert_path' => public_path('/rsa/alipayRootCert.crt'),# 地址
            'return_url' => 'www.baidu.com',# 支付成功之后回调地址
            'notify_url' => 'www.cs.com', # 异步通知会掉地址
            'mode' => Pay::MODE_SANDBOX, # (如果是沙箱开发)设置为沙箱模式，
        ],
    ],
    'wechat' => [
        'default' => [
            // 公众号 的 app_id
            'mp_app_id' => '',
            // 小程序 的 app_id
            'mini_app_id' => '',
            // app 的 app_id
            'app_id' => '',
            // 商户号
            'mch_id' => '',
            // 合单 app_id
            'combine_app_id' => '',
            // 合单商户号
            'combine_mch_id' => '',
            // 商户秘钥
            'mch_secret_key' => '',
            // 商户私钥
            'mch_secret_cert' => '',
            // 商户公钥证书路径
            'mch_public_cert_path' => '',
            // 微信公钥证书路径
            'wechat_public_cert_path' => [
                '' => '',
            ],
            'notify_url' => '',
            'mode' => Pay::MODE_NORMAL,
        ],
    ],
    'http' => [ // optional
        'timeout' => 5.0,
        'connect_timeout' => 5.0,
        // 更多配置项请参考 [Guzzle](https://guzzle-cn.readthedocs.io/zh_CN/latest/request-options.html)
    ],
    // optional，默认 warning；日志路径为：sys_get_temp_dir().'/logs/yansongda.pay.log'
    'logger' => [
        'enable' => false,
        'file' => storage_path('logs/alipay.log'),
        'level' => 'debug',
        'type' => 'single', // optional, 可选 daily.
        'max_file' => 30,
    ],
];

```



## 使用示例

- 扫码支付

```php
    # 扫码支付- scan 
    public function index()
    {
        $result = Pay::alipay(config('pay'))->scan([
            'out_trade_no' => ''.time().\Str::random(32),# 订单编号
            'total_amount' => 1,#金额
            'subject' => '扫码支付示例',#标题
        ]);
        return $result;
    }
 # 扫码支付返回结果示例
{
    "code":"10000",
    "msg":"Success",
    "out_trade_no":"1630760185qvBkrxEDXVFrHjxciQ6PR9YGVqeYeIvb", # 返回的订单编号
    "qr_code":"https:\/\/qr.alipay.com\/bax04435bvvohvugbyth0083" # 扫码的图片
}
# 注意事项
/*
 *返回的图片需要前端解析成二维码才可以使用，如果本地想测试的话可以使用微微二维码等
 *二维码网站将网址解析成二维码图片然后就可以扫码使用
*/
```



# 遇到的bug

###  1. 沙箱支付存在钓鱼风险解决办法

> 毫不容器搭建起来了支付宝支付结果支付的时候显示钓鱼风险
>
> 好在万能的百度解决方案比较多，

- 解决方案

> 参考[资料](https://blog.csdn.net/MacWx/article/details/107410685)
>
> 关闭所有的支付界面,**Crtl+Shift+delete,清空浏览器缓存**即可
