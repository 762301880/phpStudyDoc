# 自定义监控异常报错发送钉钉通知

## 资料

| 名称                                 | 地址                                                         |
| ------------------------------------ | ------------------------------------------------------------ |
| laravel官方文档:(**基础功能> 错误**) | [link](https://learnku.com/docs/laravel/8.x/errors/9375)     |
| 网络博客                             | [link](https://blog.csdn.net/haibo0668/article/details/125236649) |



## 代码示例

**添加异常类处理**

> 在**app\Exceptions\Handler.php**中监控代码
>
> 优化**日后如果真的使用的情况下可以作成异步通知走队列或者事件**

```php
<?php

namespace App\Exceptions;

use App\Services\DingDingService;
use App\Traits\ApplyResponseLayout;
use Illuminate\Auth\AuthenticationException;
use Illuminate\Foundation\Exceptions\Handler as ExceptionHandler;
use Throwable;

class Handler extends ExceptionHandler
{
    use ApplyResponseLayout;

    /**
     * A list of the exception types that are not reported.
     *
     * @var array
     */
    protected $dontReport = [
        //
    ];

    /**
     * A list of the inputs that are never flashed for validation exceptions.
     *
     * @var array
     */
    protected $dontFlash = [
        'current_password',
        'password',
        'password_confirmation',
    ];

    /**
     * Register the exception handling callbacks for the application.
     *
     * @return void
     */
    public function register()
    {

        $this->reportable(function (Throwable $e) {
              //下面的通知也可以写在这里
        });
    }
    public function report(Throwable $e)
    {
        $data['content'] = [
            "报错行数" => $e->getLine(),
            "报错代码位置" => $e->getFile(),
            "报错原因" => $e->getMessage(),
            "报错具体原因" => $e->getTraceAsString(),
            "报错时间" => date('Y-m-d H:i:s'),
        ];
        DingDingService::sendNotice($data);//发送钉钉通知
        return false; // TODO: Change the autogenerated stub
    }

    protected function unauthenticated($request, AuthenticationException $exception)
    {
        return $this->error('api_token验证失败,请重新登录');
    }
}

```

**定义钉钉通知**

**配置钉钉配置**

> 在**config\dingding.php** 中添加

```shell
<?php

return [
    //机器人配置
    'robot' => [
        'dd_bot_token' => "you_dingding_token",//钉钉token
        'dd_bot_secret' => "you_dingding_secret",//钉钉密钥
    ]
];
```

**服务类**

```shell
<?php


namespace App\Services;


use Illuminate\Support\Facades\Log;

class DingDingService
{
    public static function sendNotice($data)
    {
        $url = config('dingding.robot.dd_bot_token');
        $time = time() * 1000;//毫秒级时间戳
        $secret = config('dingding.robot.dd_bot_secret');
        if (empty($url) || empty($secret)) return true;
        $sign = hash_hmac('sha256', $time . "\n" . $secret, $secret, true);
        $sign = base64_encode($sign);
        $sign = urlencode($sign);
        $content = $data['content'] ?? "";
        $msg = [
            'msgtype' => 'text',//这是文件发送类型，可以根据需求调整
            'text' => [
                'content' => $content,
            ],
        ];
        $url = "{$url}&timestamp={$time}&sign={$sign}";
        $res = self::request_by_curl($url, $msg);
        Log::info("异常报错通知:" . $res);
    }

    public static function request_by_curl($remote_server, $post_string)
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $remote_server);
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 5);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json;charset=utf-8'));
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($post_string));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        // 线下环境不用开启curl证书验证, 未调通情况可尝试添加该代码
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
        $data = curl_exec($ch);
        curl_close($ch);
        return $data;
    }
}

```

## 测试异常

> 就举个简单的例子吧 除法计算**0**不能作为除数,所以随便找个控制方法里面打印个变量**任意值/0**

````shell
$result=10/0;
return $result;
````

**上诉做完之后直接就可以在钉钉群里看见报错的具体信息**