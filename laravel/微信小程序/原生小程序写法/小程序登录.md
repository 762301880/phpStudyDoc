# 一  文档

- 后端小程序登录接口文档

| name       | url                                                          |
| ---------- | ------------------------------------------------------------ |
| 小程序登录 | [小程序登录](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html) |

- 前台小程序登录文档

| name           | url                                                          |
| -------------- | ------------------------------------------------------------ |
| 前端小程序登录 | [小程序登录](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html) |

# 二  api说明

##  2.1请求接口说明

### 2.1.1原生写法依据小程序提供的`api`接口调用登录

 ```php
GET 请求 
https://api.weixin.qq.com/sns/jscode2session?appid=APPID&secret=SECRET&js_code=JSCODE&grant_type=authorization_code
 ```

### 2.1.2请求参数

| 属性       | 类型   | 默认值 | 必填 | 说明                                      |
| :--------- | :----- | :----- | :--- | :---------------------------------------- |
| appid      | string |        | 是   | 小程序 appId                              |
| secret     | string |        | 是   | 小程序 appSecret                          |
| js_code    | string |        | 是   | 登录时获取的 code                         |
| grant_type | string |        | 是   | 授权类型，此处只需填写 authorization_code |

### 2.1.3返回值

**Object**

返回的 JSON 数据包

| 属性        | 类型   | 说明                                                         |
| :---------- | :----- | :----------------------------------------------------------- |
| openid      | string | 用户唯一标识                                                 |
| session_key | string | 会话密钥                                                     |
| unionid     | string | 用户在开放平台的唯一标识符，若当前小程序已绑定到微信开放平台帐号下会返回，详见 [UnionID 机制说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/union-id.html)。 |
| errcode     | number | 错误码                                                       |
| errmsg      | string | 错误信息                                                     |

**errcode 的合法值**

| 值    | 说明                           | 最低版本 |
| :---- | :----------------------------- | :------- |
| -1    | 系统繁忙，此时请开发者稍候再试 |          |
| 0     | 请求成功                       |          |
| 40029 | code 无效                      |          |
| 45011 | 频率限制，每个用户每分钟100次  |          |

#  三 `laravel`原生调用方法

# 思路

> 看上诉的逻辑就可以看出前端调用[wx.login](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)会返回一个***code(临时登录凭证)***给后端,后端直接拿到获取的
>
> [wx.login获取code](https://edu.csdn.net/course/detail/27184?spm=1001.2101.3001.6650.5&utm_medium=distribute.pc_relevant.none-task-course-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-course-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.no_search_link)
>
> 传递code到服务器，获取session_key和openid
>
> 获取iv和encryptedData
>
> 解密返回数据，获取手机号码

## 图解

![1635831833(1).jpg](https://i.loli.net/2021/11/02/fXuKwJPQjveHSmi.png)

## 代码示例

```php
//微信验证登录
public function wechatAuthLogin($code){
$appId = "WECHAT_OFFICIAL_ACCOUNT_APPID";//自己配置
$appSecret = "WECHAT_OFFICIAL_ACCOUNT_SECRET";//自己配置
$url="https://api.weixin.qq.com/sns/jscode2session?appid={$appId}&secret={$appSecret}&js_code={$code}&grant_type=authorization_code";
//错误返回异常抛出这里忽略,真实开发记得加上    
return json_decode(file_get_contents($url),true));
}
```

**上诉返回结果**

```php
array:3 [
  "session_key" => "YQhz8g6Nrfcm/wmOCc8W1A=="
  "openid" => "ol9VX4wBdwiBU5iIj8oJXdTC5Yjs"
  "unionid" => "o30yb047hcGH1bRN6L3rgoeBv7Uw"
]
```

**下面还有解析上面的结果获取用户信息展示没有太多的资料日后解决**
