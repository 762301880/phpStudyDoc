# å¾ªç¯æ•°æ®ä¼˜åŒ–

**é€»è¾‘ç¤ºä¾‹**

> æˆ‘æœ‰ä¸€ä¸ªæ‰©å±•å­—æ®µ  å¯æ˜¯å¾ªç¯ä¸­æ¯æ¬¡è°ƒç”¨**AreaService::getInstance()->getIdInFullNameList();** éƒ½è¦æ‰§è¡ŒredisæŸ¥è¯¢å°±å¾ˆæ…¢

```php
public function appendText(cyModel $cy)
    {
        $areaList = AreaService::getInstance()->getIdInFullNameList();
        $cy->area_text = $areaList[$cy->area] ?? "";

        $cy->staff_number_history = json_decode($cy->staff_number_history, true);

        $cy_source_list = $this->getCySourceKeyValueList();
        $cy->cy_source_text = $cy_source_list[$cy->cy_source] ?? "";

        $cy_state_list = $this->getCyStateKeyValueList();
        $cy->cy_state_text = $cy_state_list[$cy->cy_state] ?? "";

        $cy_project_list = $this->getCyProjectKeyValueList();
        $cy->cy_project_text = $cy_project_list[$cy->cy_project] ?? "";
        return $cy;
    } 
```

è¿™ä¸ªé—®é¢˜çš„ç“¶é¢ˆç‚¹å°±åœ¨äº **`AreaService::getInstance()->getIdInFullNameList()` æ¯æ¬¡å¾ªç¯éƒ½é‡æ–°æŸ¥è¯¢ redis**ã€‚
 è§£å†³æ€è·¯å°±æ˜¯ï¼š**æŠŠè¿™ä¸ªç»“æœç¼“å­˜åˆ°å†…å­˜é‡Œï¼ˆæ–¹æ³•çº§ / ç±»çº§é™æ€å˜é‡ / å¤–éƒ¨æå‰è·å–ï¼‰**ï¼Œé¿å…åœ¨å¾ªç¯ä¸­åå¤è°ƒç”¨ã€‚

å¯ä»¥æ”¹é€ å‡ ç§æ–¹å¼ï¼š

## æ–¹æ³•ä¸€ï¼šåœ¨å¾ªç¯å¤–éƒ¨æå‰è·å–

```php
$areaList = AreaService::getInstance()->getIdInFullNameList();

foreach ($cyList as $cy) {
    $this->appendText($cy, $areaList);
}
```

ç„¶åä¿®æ”¹ `appendText`ï¼š

```php
public function appendText(cyModel $cy, array $areaList)
{
    $cy->area_text = $areaList[$cy->area] ?? "";

    $cy->staff_number_history = json_decode($cy->staff_number_history, true);

    $cy_source_list = $this->getCySourceKeyValueList();
    $cy->cy_source_text = $cy_source_list[$cy->cy_source] ?? "";

    $cy_state_list = $this->getCyStateKeyValueList();
    $cy->cy_state_text = $cy_state_list[$cy->cy_state] ?? "";

    $cy_project_list = $this->getCyProjectKeyValueList();
    $cy->cy_project_text = $cy_project_list[$cy->cy_project] ?? "";

    return $cy;
}
```

## æ–¹æ³•äºŒï¼šé™æ€ç¼“å­˜ï¼ˆç±»å†…å­˜ç¼“å­˜ï¼‰

å¦‚æœä½ ä¸èƒ½æ”¹è°ƒç”¨æ–¹å¼ï¼Œå¯ä»¥åœ¨ `appendText` å†…éƒ¨ç”¨ **é™æ€å˜é‡ç¼“å­˜**ï¼š

> è¿™æ ·ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šå» Redisï¼Œåé¢éƒ½æ˜¯å†…å­˜é‡Œç›´æ¥æ‹¿ï¼Œå¾ªç¯ä¸­ä¸ä¼šå†è§¦å‘ redis æŸ¥è¯¢ã€‚

```php
public function appendText(cyModel $cy)
{
    static $areaList = null;
    if ($areaList === null) {
        $areaList = AreaService::getInstance()->getIdInFullNameList();
    }

    $cy->area_text = $areaList[$cy->area] ?? "";
    $cy->staff_number_history = json_decode($cy->staff_number_history, true);

    static $cy_source_list = null;
    if ($cy_source_list === null) {
        $cy_source_list = $this->getCySourceKeyValueList();
    }
    $cy->cy_source_text = $cy_source_list[$cy->cy_source] ?? "";

    static $cy_state_list = null;
    if ($cy_state_list === null) {
        $cy_state_list = $this->getCyStateKeyValueList();
    }
    $cy->cy_state_text = $cy_state_list[$cy->cy_state] ?? "";

    static $cy_project_list = null;
    if ($cy_project_list === null) {
        $cy_project_list = $this->getCyProjectKeyValueList();
    }
    $cy->cy_project_text = $cy_project_list[$cy->cy_project] ?? "";

    return $cy;
}
```

## æ–¹æ³•ä¸‰ï¼šä¾èµ–æ³¨å…¥

æ›´è§„èŒƒä¸€ç‚¹çš„åšæ³•ï¼Œæ˜¯åœ¨è°ƒç”¨ service çš„æ—¶å€™ï¼Œå°±æŠŠ areaListã€cy_source_list ç­‰ä¾èµ–ä¼ è¿›å»ï¼Œè¿™æ · `appendText` å°±æ˜¯çº¯ç²¹çš„æ•°æ®åŠ å·¥å‡½æ•°ã€‚



## é™æ€å˜é‡åœ¨å‡½æ•°ä½œç”¨åŸŸå†… åˆå§‹åŒ–æ‰§è¡Œä»£ç æµ‹è¯•

åœ¨ PHP é‡Œï¼Œ**é™æ€å˜é‡åœ¨å‡½æ•°ä½œç”¨åŸŸå†…åªä¼šåˆå§‹åŒ–ä¸€æ¬¡**ï¼Œåç»­å†è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå€¼ä¼šä¸€ç›´ä¿ç•™åœ¨å†…å­˜é‡Œï¼Œä¸ä¼šé‡æ–°èµ‹å€¼ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```php
function test() {
    static $data = null;
    if ($data === null) {
        echo "æ‰§è¡ŒæŸ¥è¯¢...\n";
        $data = ['a' => 1, 'b' => 2]; // æ¨¡æ‹ŸredisæŸ¥è¯¢
    }
    return $data;
}

for ($i = 0; $i < 3; $i++) {
    $res = test();
    print_r($res);
}
```

è¾“å‡ºç»“æœï¼š

```csharp
æ‰§è¡ŒæŸ¥è¯¢...
Array
(
    [a] => 1
    [b] => 2
)
Array
(
    [a] => 1
    [b] => 2
)
Array
(
    [a] => 1
    [b] => 2
)
```

å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ `$data === null`ï¼Œäºæ˜¯æ‰§è¡Œäº†ã€ŒæŸ¥è¯¢ã€é€»è¾‘ï¼ˆæ¯”å¦‚ Redisï¼‰ã€‚
- åé¢ä¸¤æ¬¡è°ƒç”¨æ—¶ `$data !== null`ï¼Œå°±ç›´æ¥è¿”å›å·²æœ‰çš„æ•°æ®ï¼Œä¸ä¼šå†èµ° Redisã€‚

------

æ‰€ä»¥æ”¾åˆ°ä½ çš„ä»£ç é‡Œï¼š

- **ç¬¬ä¸€æ¬¡è°ƒç”¨ `appendText()`** â†’ Redis æŸ¥è¯¢ä¸€æ¬¡ï¼Œèµ‹å€¼ç»™é™æ€å˜é‡ã€‚
- **åç»­å¾ªç¯è°ƒç”¨ `appendText()`** â†’ ç›´æ¥ç”¨é™æ€å˜é‡é‡Œçš„æ•°æ®ï¼Œä¸ä¼šå†å» Redisã€‚

è¿™æ ·å°±èƒ½ä¿è¯å¾ªç¯é‡Œé«˜æ•ˆè¿è¡Œäº†ã€‚

## æ€§èƒ½è§£è¯´

ä» **æ€§èƒ½è§’åº¦** æ¥çœ‹ï¼Œæ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒåœ¨å¾ªç¯è¿‡ç¨‹ä¸­åŸºæœ¬ **æ²¡æœ‰å·®åˆ«**ï¼ŒåŸå› æ˜¯ï¼š

- **æ–¹æ³•ä¸€**ï¼šåœ¨å¾ªç¯å¤–å…ˆæŸ¥ä¸€æ¬¡ Redisï¼Œåç»­å¾ªç¯ç›´æ¥ç”¨ä¼ è¿›æ¥çš„æ•°ç»„ã€‚
- **æ–¹æ³•äºŒ**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°æ—¶æŸ¥ä¸€æ¬¡ Redisï¼Œèµ‹å€¼ç»™é™æ€å˜é‡ï¼Œåç»­å¾ªç¯ç›´æ¥ç”¨é™æ€å˜é‡ã€‚

ä¸¤è€…éƒ½åªä¼šè§¦å‘ **ä¸€æ¬¡ Redis æŸ¥è¯¢**ï¼Œåç»­å¾ªç¯éƒ½æ˜¯èµ°å†…å­˜ã€‚

------

### ç»†å¾®å·®å¼‚ï¼š

1. **æ–¹æ³•ä¸€**
   - ä¼˜ç‚¹ï¼šé€»è¾‘æ¸…æ™°ï¼Œè°ä¾èµ–æ•°æ®å°±æ˜ç¡®ä¼ è¿›å»ï¼Œå‡½æ•°æ˜¯çº¯å‡½æ•°ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚
   - ç¼ºç‚¹ï¼šè°ƒç”¨åœ°æ–¹éœ€è¦æ”¹ä»£ç ï¼ˆè¦å…ˆå‡†å¤‡å¥½ `$areaList`ã€`$cy_source_list` ç­‰å†ä¼ ï¼‰ã€‚
2. **æ–¹æ³•äºŒ**
   - ä¼˜ç‚¹ï¼šè°ƒç”¨æ–¹ä¸ç”¨æ”¹ï¼Œæ”¹é€ æœ€å°ï¼Œæ—§ä»£ç ç›´æ¥ç”Ÿæ•ˆã€‚
   - ç¼ºç‚¹ï¼šå‡½æ•°å¯¹å¤–éƒ¨ä¾èµ–â€œéšè—â€äº†ï¼Œè¡¨é¢ä¸Šçœ‹èµ·æ¥æ¯æ¬¡éƒ½æŸ¥ï¼Œä½†å…¶å®åªæŸ¥ä¸€æ¬¡ï¼Œä¸å¦‚æ–¹æ³•ä¸€é‚£ä¹ˆç›´è§‚ã€‚
3. **æ‰§è¡Œé€Ÿç‡**
   - ä¸¤è€…åœ¨ PHP å±‚é¢çš„æ€§èƒ½å·®å¼‚å‡ ä¹å¯ä»¥å¿½ç•¥ï¼ˆæ–¹æ³•äºŒæ¯æ¬¡å¤šä¸€æ¬¡ `if ($var === null)` åˆ¤æ–­ï¼Œæˆæœ¬æä½ï¼Œçº³ç§’çº§ï¼‰ã€‚
   - çœŸæ­£è€—æ—¶çš„ Redis æŸ¥è¯¢ï¼Œä¸¤ç§æ–¹æ³•éƒ½æ˜¯ **åªæ‰§è¡Œä¸€æ¬¡**ã€‚

------

ğŸ‘‰ æ€»ç»“ï¼š

- **æ€§èƒ½ï¼šå‡ ä¹ä¸€æ ·**ã€‚
- **å¯ç»´æŠ¤æ€§ï¼šæ–¹æ³•ä¸€æ›´æ¸…æ™°ï¼Œæ–¹æ³•äºŒæ”¹é€ æˆæœ¬ä½**ã€‚

å¦‚æœä½ çš„é¡¹ç›®è¦é•¿æœŸç»´æŠ¤ã€å¤šäººåä½œï¼Œæ¨èæ–¹æ³•ä¸€ï¼›å¦‚æœä½ ç°åœ¨å°±æ˜¯è¦å¿«é€Ÿä¼˜åŒ–æ€§èƒ½ï¼Œä¸æƒ³åŠ¨è°ƒç”¨é€»è¾‘ï¼Œç›´æ¥ä¸Šæ–¹æ³•äºŒã€‚

#  ç®€åŒ–é€»è¾‘åˆ¤æ–­

**ç®€åŒ–å‰**

> å…ˆçœ‹ä¸€ä¸‹ç®€åŒ–å‰çš„é€»è¾‘ 
>
> ifé‡Œé¢ åˆåˆ¤æ–­äº†if è¯»èµ·æ¥å¾ˆéº»çƒ¦

```php
            ###########################################################
            $is_transfer = false;
            //å¦‚æœè´Ÿè´£äººç¦»èŒ&&æœªä»˜æ¸…æƒ…å†µä¸‹(å¯ä»¥è½¬äº¤ç»™å…¶ä»–äººå‘˜)
            if (
                !empty($headModel)
                &&
                $headModel->staff_work_status == AssetMoreEnum::retuenValueFromType('4', 'work_status') //ç¬¬ä¸€å±‚ åªåˆ¤æ–­ç¦»èŒ
            ) {
                //æ²¡æœ‰ç­¾åˆåŒæˆ–è€…æœªä»˜æ¸… éƒ½å±äº æœªä»˜æ¸…
                if (empty($cySigned) || (!empty($cySigned) && $cySigned->is_full_money == CySigend::IS_FULL_MONEY__1)) { //ç¬¬äºŒå±‚ åˆ¤æ–­æœªä»˜æ¸…
                   $is_transfer = true;
                }
            }
            ###########################################################

            //å¦‚æœåˆåŒä¸ä¸ºç©ºã€æ”¶æ¬¾é‡‘é¢å¤§äº0ã€&& (!ç¦»èŒæœªä»˜æ¸…)
            if (!empty($cySigned) && $cySigned->total_received_money > 0 && $is_transfer == false) throw new PxsApiException('å·²ç­¾åˆåŒå¹¶æ”¶æ¬¾ä¸å¯å†è½¬äº¤ç»™å…¶ä»–è´Ÿè´£äºº!');
```



**ç®€åŒ–å**

> ä½¿ç”¨æ›´å…·æè¿°æ€§çš„å˜é‡å
>
> å°†å¤æ‚çš„æ¡ä»¶åˆ¤æ–­åˆ†è§£ä¸ºç‹¬ç«‹çš„å°åˆ¤æ–­
> æ¸…æ™°åœ°è¡¨è¾¾äº†ä¸šåŠ¡é€»è¾‘å…³ç³»
> ä¿ç•™äº†åŸæœ‰çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™

```php
            // ç®€åŒ–ç‰ˆé€»è¾‘
            $canTransfer = false;
            // æ£€æŸ¥è´Ÿè´£äººæ˜¯å¦å·²ç¦»èŒ
            $isHeadResigned = !empty($headModel) && $headModel->getOrigin('staff_work_status') == AssetMoreEnum::retuenValueFromType('4', 'work_status');
            // æ£€æŸ¥æ˜¯å¦æœªä»˜æ¸…ï¼ˆæ²¡æœ‰åˆåŒæˆ–åˆåŒæœªä»˜æ¸…ï¼‰
            $isUnpaid = empty($cySigned) || (!empty($cySigned) && $cySigned->is_full_money == CySigend::IS_FULL_MONEY__1);
            // å¦‚æœè´Ÿè´£äººå·²ç¦»èŒä¸”æœªä»˜æ¸…ï¼Œåˆ™å…è®¸è½¬äº¤
            if ($isHeadResigned && $isUnpaid) $canTransfer = true;//trueå…è®¸è½¬äº¤

            // å¦‚æœå·²ç­¾åˆåŒå¹¶å·²æ”¶æ¬¾ï¼Œä¸”ä¸ç¬¦åˆç‰¹æ®Šè½¬äº¤æ¡ä»¶ï¼Œåˆ™ç¦æ­¢è½¬äº¤
            $has_total_received_money = !empty($cySigned) && $cySigned->total_received_money > 0;//å·²ç­¾åˆåŒå¹¶å·²æ”¶æ¬¾
            if ($has_total_received_money && $canTransfer == false) { //æœ‰æ”¶æ¬¾çš„ && ä¸ç¬¦åˆç‰¹æ®Šè½¬äº¤æ¡ä»¶
                throw new PxsApiException('å·²ç­¾åˆåŒå¹¶æ”¶æ¬¾ä¸å¯å†è½¬äº¤ç»™å…¶ä»–è´Ÿè´£äºº!');
            }
```

