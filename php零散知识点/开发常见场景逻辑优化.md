# å¾ªçŽ¯æ•°æ®ä¼˜åŒ–

**é€»è¾‘ç¤ºä¾‹**

> æˆ‘æœ‰ä¸€ä¸ªæ‰©å±•å­—æ®µ  å¯æ˜¯å¾ªçŽ¯ä¸­æ¯æ¬¡è°ƒç”¨**AreaService::getInstance()->getIdInFullNameList();** éƒ½è¦æ‰§è¡ŒredisæŸ¥è¯¢å°±å¾ˆæ…¢

```php
public function appendText(cyModel $cy)
    {
        $areaList = AreaService::getInstance()->getIdInFullNameList();
        $cy->area_text = $areaList[$cy->area] ?? "";

        $cy->staff_number_history = json_decode($cy->staff_number_history, true);

        $cy_source_list = $this->getCySourceKeyValueList();
        $cy->cy_source_text = $cy_source_list[$cy->cy_source] ?? "";

        $cy_state_list = $this->getCyStateKeyValueList();
        $cy->cy_state_text = $cy_state_list[$cy->cy_state] ?? "";

        $cy_project_list = $this->getCyProjectKeyValueList();
        $cy->cy_project_text = $cy_project_list[$cy->cy_project] ?? "";
        return $cy;
    } 
```

è¿™ä¸ªé—®é¢˜çš„ç“¶é¢ˆç‚¹å°±åœ¨äºŽ **`AreaService::getInstance()->getIdInFullNameList()` æ¯æ¬¡å¾ªçŽ¯éƒ½é‡æ–°æŸ¥è¯¢ redis**ã€‚
 è§£å†³æ€è·¯å°±æ˜¯ï¼š**æŠŠè¿™ä¸ªç»“æžœç¼“å­˜åˆ°å†…å­˜é‡Œï¼ˆæ–¹æ³•çº§ / ç±»çº§é™æ€å˜é‡ / å¤–éƒ¨æå‰èŽ·å–ï¼‰**ï¼Œé¿å…åœ¨å¾ªçŽ¯ä¸­åå¤è°ƒç”¨ã€‚

å¯ä»¥æ”¹é€ å‡ ç§æ–¹å¼ï¼š

## æ–¹æ³•ä¸€ï¼šåœ¨å¾ªçŽ¯å¤–éƒ¨æå‰èŽ·å–

```php
$areaList = AreaService::getInstance()->getIdInFullNameList();

foreach ($cyList as $cy) {
    $this->appendText($cy, $areaList);
}
```

ç„¶åŽä¿®æ”¹ `appendText`ï¼š

```php
public function appendText(cyModel $cy, array $areaList)
{
    $cy->area_text = $areaList[$cy->area] ?? "";

    $cy->staff_number_history = json_decode($cy->staff_number_history, true);

    $cy_source_list = $this->getCySourceKeyValueList();
    $cy->cy_source_text = $cy_source_list[$cy->cy_source] ?? "";

    $cy_state_list = $this->getCyStateKeyValueList();
    $cy->cy_state_text = $cy_state_list[$cy->cy_state] ?? "";

    $cy_project_list = $this->getCyProjectKeyValueList();
    $cy->cy_project_text = $cy_project_list[$cy->cy_project] ?? "";

    return $cy;
}
```

## æ–¹æ³•äºŒï¼šé™æ€ç¼“å­˜ï¼ˆç±»å†…å­˜ç¼“å­˜ï¼‰

å¦‚æžœä½ ä¸èƒ½æ”¹è°ƒç”¨æ–¹å¼ï¼Œå¯ä»¥åœ¨ `appendText` å†…éƒ¨ç”¨ **é™æ€å˜é‡ç¼“å­˜**ï¼š

> è¿™æ ·ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šåŽ» Redisï¼ŒåŽé¢éƒ½æ˜¯å†…å­˜é‡Œç›´æŽ¥æ‹¿ï¼Œå¾ªçŽ¯ä¸­ä¸ä¼šå†è§¦å‘ redis æŸ¥è¯¢ã€‚

```php
public function appendText(cyModel $cy)
{
    static $areaList = null;
    if ($areaList === null) {
        $areaList = AreaService::getInstance()->getIdInFullNameList();
    }

    $cy->area_text = $areaList[$cy->area] ?? "";
    $cy->staff_number_history = json_decode($cy->staff_number_history, true);

    static $cy_source_list = null;
    if ($cy_source_list === null) {
        $cy_source_list = $this->getCySourceKeyValueList();
    }
    $cy->cy_source_text = $cy_source_list[$cy->cy_source] ?? "";

    static $cy_state_list = null;
    if ($cy_state_list === null) {
        $cy_state_list = $this->getCyStateKeyValueList();
    }
    $cy->cy_state_text = $cy_state_list[$cy->cy_state] ?? "";

    static $cy_project_list = null;
    if ($cy_project_list === null) {
        $cy_project_list = $this->getCyProjectKeyValueList();
    }
    $cy->cy_project_text = $cy_project_list[$cy->cy_project] ?? "";

    return $cy;
}
```

## æ–¹æ³•ä¸‰ï¼šä¾èµ–æ³¨å…¥

æ›´è§„èŒƒä¸€ç‚¹çš„åšæ³•ï¼Œæ˜¯åœ¨è°ƒç”¨ service çš„æ—¶å€™ï¼Œå°±æŠŠ areaListã€cy_source_list ç­‰ä¾èµ–ä¼ è¿›åŽ»ï¼Œè¿™æ · `appendText` å°±æ˜¯çº¯ç²¹çš„æ•°æ®åŠ å·¥å‡½æ•°ã€‚



## é™æ€å˜é‡åœ¨å‡½æ•°ä½œç”¨åŸŸå†… åˆå§‹åŒ–æ‰§è¡Œä»£ç æµ‹è¯•

åœ¨ PHP é‡Œï¼Œ**é™æ€å˜é‡åœ¨å‡½æ•°ä½œç”¨åŸŸå†…åªä¼šåˆå§‹åŒ–ä¸€æ¬¡**ï¼ŒåŽç»­å†è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå€¼ä¼šä¸€ç›´ä¿ç•™åœ¨å†…å­˜é‡Œï¼Œä¸ä¼šé‡æ–°èµ‹å€¼ã€‚

æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```php
function test() {
    static $data = null;
    if ($data === null) {
        echo "æ‰§è¡ŒæŸ¥è¯¢...\n";
        $data = ['a' => 1, 'b' => 2]; // æ¨¡æ‹ŸredisæŸ¥è¯¢
    }
    return $data;
}

for ($i = 0; $i < 3; $i++) {
    $res = test();
    print_r($res);
}
```

è¾“å‡ºç»“æžœï¼š

```csharp
æ‰§è¡ŒæŸ¥è¯¢...
Array
(
    [a] => 1
    [b] => 2
)
Array
(
    [a] => 1
    [b] => 2
)
Array
(
    [a] => 1
    [b] => 2
)
```

å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ `$data === null`ï¼ŒäºŽæ˜¯æ‰§è¡Œäº†ã€ŒæŸ¥è¯¢ã€é€»è¾‘ï¼ˆæ¯”å¦‚ Redisï¼‰ã€‚
- åŽé¢ä¸¤æ¬¡è°ƒç”¨æ—¶ `$data !== null`ï¼Œå°±ç›´æŽ¥è¿”å›žå·²æœ‰çš„æ•°æ®ï¼Œä¸ä¼šå†èµ° Redisã€‚

------

æ‰€ä»¥æ”¾åˆ°ä½ çš„ä»£ç é‡Œï¼š

- **ç¬¬ä¸€æ¬¡è°ƒç”¨ `appendText()`** â†’ Redis æŸ¥è¯¢ä¸€æ¬¡ï¼Œèµ‹å€¼ç»™é™æ€å˜é‡ã€‚
- **åŽç»­å¾ªçŽ¯è°ƒç”¨ `appendText()`** â†’ ç›´æŽ¥ç”¨é™æ€å˜é‡é‡Œçš„æ•°æ®ï¼Œä¸ä¼šå†åŽ» Redisã€‚

è¿™æ ·å°±èƒ½ä¿è¯å¾ªçŽ¯é‡Œé«˜æ•ˆè¿è¡Œäº†ã€‚

## æ€§èƒ½è§£è¯´

ä»Ž **æ€§èƒ½è§’åº¦** æ¥çœ‹ï¼Œæ–¹æ³•ä¸€å’Œæ–¹æ³•äºŒåœ¨å¾ªçŽ¯è¿‡ç¨‹ä¸­åŸºæœ¬ **æ²¡æœ‰å·®åˆ«**ï¼ŒåŽŸå› æ˜¯ï¼š

- **æ–¹æ³•ä¸€**ï¼šåœ¨å¾ªçŽ¯å¤–å…ˆæŸ¥ä¸€æ¬¡ Redisï¼ŒåŽç»­å¾ªçŽ¯ç›´æŽ¥ç”¨ä¼ è¿›æ¥çš„æ•°ç»„ã€‚
- **æ–¹æ³•äºŒ**ï¼šç¬¬ä¸€æ¬¡è°ƒç”¨å‡½æ•°æ—¶æŸ¥ä¸€æ¬¡ Redisï¼Œèµ‹å€¼ç»™é™æ€å˜é‡ï¼ŒåŽç»­å¾ªçŽ¯ç›´æŽ¥ç”¨é™æ€å˜é‡ã€‚

ä¸¤è€…éƒ½åªä¼šè§¦å‘ **ä¸€æ¬¡ Redis æŸ¥è¯¢**ï¼ŒåŽç»­å¾ªçŽ¯éƒ½æ˜¯èµ°å†…å­˜ã€‚

------

### ç»†å¾®å·®å¼‚ï¼š

1. **æ–¹æ³•ä¸€**
   - ä¼˜ç‚¹ï¼šé€»è¾‘æ¸…æ™°ï¼Œè°ä¾èµ–æ•°æ®å°±æ˜Žç¡®ä¼ è¿›åŽ»ï¼Œå‡½æ•°æ˜¯çº¯å‡½æ•°ï¼Œæ–¹ä¾¿æµ‹è¯•ã€‚
   - ç¼ºç‚¹ï¼šè°ƒç”¨åœ°æ–¹éœ€è¦æ”¹ä»£ç ï¼ˆè¦å…ˆå‡†å¤‡å¥½ `$areaList`ã€`$cy_source_list` ç­‰å†ä¼ ï¼‰ã€‚
2. **æ–¹æ³•äºŒ**
   - ä¼˜ç‚¹ï¼šè°ƒç”¨æ–¹ä¸ç”¨æ”¹ï¼Œæ”¹é€ æœ€å°ï¼Œæ—§ä»£ç ç›´æŽ¥ç”Ÿæ•ˆã€‚
   - ç¼ºç‚¹ï¼šå‡½æ•°å¯¹å¤–éƒ¨ä¾èµ–â€œéšè—â€äº†ï¼Œè¡¨é¢ä¸Šçœ‹èµ·æ¥æ¯æ¬¡éƒ½æŸ¥ï¼Œä½†å…¶å®žåªæŸ¥ä¸€æ¬¡ï¼Œä¸å¦‚æ–¹æ³•ä¸€é‚£ä¹ˆç›´è§‚ã€‚
3. **æ‰§è¡Œé€ŸçŽ‡**
   - ä¸¤è€…åœ¨ PHP å±‚é¢çš„æ€§èƒ½å·®å¼‚å‡ ä¹Žå¯ä»¥å¿½ç•¥ï¼ˆæ–¹æ³•äºŒæ¯æ¬¡å¤šä¸€æ¬¡ `if ($var === null)` åˆ¤æ–­ï¼Œæˆæœ¬æžä½Žï¼Œçº³ç§’çº§ï¼‰ã€‚
   - çœŸæ­£è€—æ—¶çš„ Redis æŸ¥è¯¢ï¼Œä¸¤ç§æ–¹æ³•éƒ½æ˜¯ **åªæ‰§è¡Œä¸€æ¬¡**ã€‚

------

ðŸ‘‰ æ€»ç»“ï¼š

- **æ€§èƒ½ï¼šå‡ ä¹Žä¸€æ ·**ã€‚
- **å¯ç»´æŠ¤æ€§ï¼šæ–¹æ³•ä¸€æ›´æ¸…æ™°ï¼Œæ–¹æ³•äºŒæ”¹é€ æˆæœ¬ä½Ž**ã€‚

å¦‚æžœä½ çš„é¡¹ç›®è¦é•¿æœŸç»´æŠ¤ã€å¤šäººåä½œï¼ŒæŽ¨èæ–¹æ³•ä¸€ï¼›å¦‚æžœä½ çŽ°åœ¨å°±æ˜¯è¦å¿«é€Ÿä¼˜åŒ–æ€§èƒ½ï¼Œä¸æƒ³åŠ¨è°ƒç”¨é€»è¾‘ï¼Œç›´æŽ¥ä¸Šæ–¹æ³•äºŒã€‚

#  ç®€åŒ–é€»è¾‘åˆ¤æ–­

**ç®€åŒ–å‰**

> å…ˆçœ‹ä¸€ä¸‹ç®€åŒ–å‰çš„é€»è¾‘ 
>
> ifé‡Œé¢ åˆåˆ¤æ–­äº†if è¯»èµ·æ¥å¾ˆéº»çƒ¦

```php
            ###########################################################
            $is_transfer = false;
            //å¦‚æžœè´Ÿè´£äººç¦»èŒ&&æœªä»˜æ¸…æƒ…å†µä¸‹(å¯ä»¥è½¬äº¤ç»™å…¶ä»–äººå‘˜)
            if (
                !empty($headModel)
                &&
                $headModel->staff_work_status == AssetMoreEnum::retuenValueFromType('4', 'work_status') //ç¬¬ä¸€å±‚ åªåˆ¤æ–­ç¦»èŒ
            ) {
                //æ²¡æœ‰ç­¾åˆåŒæˆ–è€…æœªä»˜æ¸… éƒ½å±žäºŽ æœªä»˜æ¸…
                if (empty($cySigned) || (!empty($cySigned) && $cySigned->is_full_money == CySigend::IS_FULL_MONEY__1)) { //ç¬¬äºŒå±‚ åˆ¤æ–­æœªä»˜æ¸…
                   $is_transfer = true;
                }
            }
            ###########################################################

            //å¦‚æžœåˆåŒä¸ä¸ºç©ºã€æ”¶æ¬¾é‡‘é¢å¤§äºŽ0ã€&& (!ç¦»èŒæœªä»˜æ¸…)
            if (!empty($cySigned) && $cySigned->total_received_money > 0 && $is_transfer == false) throw new PxsApiException('å·²ç­¾åˆåŒå¹¶æ”¶æ¬¾ä¸å¯å†è½¬äº¤ç»™å…¶ä»–è´Ÿè´£äºº!');
```



**ç®€åŒ–åŽ**

> ä½¿ç”¨æ›´å…·æè¿°æ€§çš„å˜é‡å
>
> å°†å¤æ‚çš„æ¡ä»¶åˆ¤æ–­åˆ†è§£ä¸ºç‹¬ç«‹çš„å°åˆ¤æ–­
> æ¸…æ™°åœ°è¡¨è¾¾äº†ä¸šåŠ¡é€»è¾‘å…³ç³»
> ä¿ç•™äº†åŽŸæœ‰çš„æ‰€æœ‰ä¸šåŠ¡è§„åˆ™

```php
            // ç®€åŒ–ç‰ˆé€»è¾‘
            $canTransfer = false;
            // æ£€æŸ¥è´Ÿè´£äººæ˜¯å¦å·²ç¦»èŒ
            $isHeadResigned = !empty($headModel) 
                && 
                $headModel->getOrigin('staff_work_status') == AssetMoreEnum::retuenValueFromType('4', 'work_status');
            // æ£€æŸ¥æ˜¯å¦æœªä»˜æ¸…ï¼ˆæ²¡æœ‰åˆåŒæˆ–åˆåŒæœªä»˜æ¸…ï¼‰
            $isUnpaid = empty($cySigned) || (!empty($cySigned) && $cySigned->is_full_money == CySigend::IS_FULL_MONEY__1);
            // å¦‚æžœè´Ÿè´£äººå·²ç¦»èŒä¸”æœªä»˜æ¸…ï¼Œåˆ™å…è®¸è½¬äº¤
            if ($isHeadResigned && $isUnpaid) $canTransfer = true;//trueå…è®¸è½¬äº¤

            // å¦‚æžœå·²ç­¾åˆåŒå¹¶å·²æ”¶æ¬¾ï¼Œä¸”ä¸ç¬¦åˆç‰¹æ®Šè½¬äº¤æ¡ä»¶ï¼Œåˆ™ç¦æ­¢è½¬äº¤
            $has_total_received_money = !empty($cySigned) && $cySigned->total_received_money > 0;//å·²ç­¾åˆåŒå¹¶å·²æ”¶æ¬¾
            if ($has_total_received_money && $canTransfer == false) { //æœ‰æ”¶æ¬¾çš„ && ä¸ç¬¦åˆç‰¹æ®Šè½¬äº¤æ¡ä»¶
                throw new PxsApiException('å·²ç­¾åˆåŒå¹¶æ”¶æ¬¾ä¸å¯å†è½¬äº¤ç»™å…¶ä»–è´Ÿè´£äºº!');
            }
```

## å®žé™…ç¤ºä¾‹åœºæ™¯

> è¿™äº›ä¼˜åŒ–æ–¹æ¡ˆçš„å…±åŒç‰¹ç‚¹ï¼š
>
> 1. å°†å¤æ‚æ¡ä»¶æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¸ƒå°”å˜é‡ï¼Œæ¯ä¸ªå˜é‡åªè´Ÿè´£ä¸€ä¸ªåˆ¤æ–­
> 2. ä½¿ç”¨æ¸…æ™°çš„å˜é‡åè¡¨è¾¾ä¸šåŠ¡å«ä¹‰ï¼ˆå¦‚`$isHeadResigned`ã€`$isUnpaid`ï¼‰
> 3. å‡å°‘åµŒå¥—å±‚çº§ï¼Œä½¿é€»è¾‘æµç¨‹æ›´çº¿æ€§
> 4. åˆ†ç¦» "æ¡ä»¶åˆ¤æ–­" å’Œ "ä¸šåŠ¡æ“ä½œ"ï¼Œä½¿ä»£ç ç»“æž„æ›´æ¸…æ™°
> 5. é‡è¦çš„ä¸šåŠ¡è§„åˆ™å¯ä»¥æå–ä¸ºé…ç½®æ•°ç»„ï¼ˆå¦‚çŠ¶æ€æµè½¬è§„åˆ™ï¼‰
>
> è¿™ç§æ–¹å¼ç‰¹åˆ«é€‚åˆç»´æŠ¤å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œå½“éœ€æ±‚å˜æ›´æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å¯¹åº”çš„æ¡ä»¶å˜é‡æˆ–è§„åˆ™é…ç½®å³å¯ã€‚

###  ç”¨æˆ·æƒé™æ ¡éªŒé€»è¾‘ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼ˆåµŒå¥—å¤æ‚ï¼‰ï¼š**

```php
if ($user) {
    if ($user->role == 'admin') {
        if ($user->status == 1) {
            // ç®¡ç†å‘˜ä¸”çŠ¶æ€æ­£å¸¸ï¼Œå…è®¸æ“ä½œ
            $allow = true;
        } else {
            $error = "ç®¡ç†å‘˜è´¦å·å·²ç¦ç”¨";
        }
    } else if ($user->role == 'editor') {
        if ($user->status == 1 && $user->hasPermission('edit')) {
            $allow = true;
        } else {
            $error = "ç¼–è¾‘æƒé™ä¸è¶³æˆ–è´¦å·å¼‚å¸¸";
        }
    } else {
        $error = "æ— æƒé™è®¿é—®";
    }
} else {
    $error = "ç”¨æˆ·æœªç™»å½•";
}
```

**ä¼˜åŒ–åŽï¼ˆæ‹†åˆ†é€»è¾‘ï¼‰ï¼š**

```php
// åŸºç¡€çŠ¶æ€åˆ¤æ–­
$isLoggedIn = !empty($user);
$isActive = $isLoggedIn && $user->status == 1;
$isAdmin = $isLoggedIn && $user->role == 'admin';
$isEditor = $isLoggedIn && $user->role == 'editor';
$editorHasPermission = $isEditor && $user->hasPermission('edit');

// æƒé™åˆ¤å®š
if (!$isLoggedIn) {
    $error = "ç”¨æˆ·æœªç™»å½•";
} elseif ($isAdmin && $isActive) {
    $allow = true;
} elseif ($isEditor && $isActive && $editorHasPermission) {
    $allow = true;
} elseif (!$isActive) {
    $error = "è´¦å·å·²ç¦ç”¨";
} elseif ($isEditor && !$editorHasPermission) {
    $error = "ç¼–è¾‘æƒé™ä¸è¶³";
} else {
    $error = "æ— æƒé™è®¿é—®";
}
```

### è®¢å•çŠ¶æ€æµè½¬é€»è¾‘ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼ˆæ¡ä»¶åˆ¤æ–­å†—é•¿ï¼‰ï¼š**

```php
if ($order && $order->status != 'cancelled') {
    if ($action == 'pay' && $order->status == 'pending') {
        $order->status = 'paid';
        $order->paid_at = date('Y-m-d H:i:s');
    } elseif ($action == 'ship' && $order->status == 'paid') {
        $order->status = 'shipped';
        $order->shipped_at = date('Y-m-d H:i:s');
    } elseif ($action == 'receive' && $order->status == 'shipped') {
        $order->status = 'completed';
        $order->completed_at = date('Y-m-d H:i:s');
    } else {
        throw new Exception("å½“å‰è®¢å•çŠ¶æ€ä¸å…è®¸æ‰§è¡Œæ­¤æ“ä½œ");
    }
} else {
    throw new Exception("è®¢å•ä¸å­˜åœ¨æˆ–å·²å–æ¶ˆ");
}
```

**ä¼˜åŒ–åŽï¼ˆçŠ¶æ€å’ŒåŠ¨ä½œåˆ†ç¦»ï¼‰ï¼š**

```php
// å‰ç½®æ¡ä»¶åˆ¤æ–­
$orderExists = !empty($order);
$orderNotCancelled = $orderExists && $order->status != 'cancelled';
$validStatusTransitions = [
    'pay' => ['from' => 'pending', 'to' => 'paid', 'field' => 'paid_at'],
    'ship' => ['from' => 'paid', 'to' => 'shipped', 'field' => 'shipped_at'],
    'receive' => ['from' => 'shipped', 'to' => 'completed', 'field' => 'completed_at'],
];

// éªŒè¯åŸºç¡€æ¡ä»¶
if (!$orderExists) throw new Exception("è®¢å•ä¸å­˜åœ¨");
if (!$orderNotCancelled) throw new Exception("è®¢å•å·²å–æ¶ˆ");
if (!isset($validStatusTransitions[$action])) throw new Exception("ä¸æ”¯æŒçš„æ“ä½œ");

// éªŒè¯çŠ¶æ€æµè½¬åˆæ³•æ€§
$transition = $validStatusTransitions[$action];
if ($order->status != $transition['from']) {
    throw new Exception("å½“å‰è®¢å•çŠ¶æ€ä¸å…è®¸æ‰§è¡Œæ­¤æ“ä½œ");
}

// æ‰§è¡ŒçŠ¶æ€æ›´æ–°
$order->status = $transition['to'];
$order->{$transition['field']} = date('Y-m-d H:i:s');
```

### æ•°æ®è¿‡æ»¤æ¡ä»¶ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼ˆæŸ¥è¯¢æ¡ä»¶åµŒå¥—ï¼‰ï¼š**

```php
$query = DB::table('products');

if (!empty($category)) {
    $query->where('category_id', $category);
    if (!empty($minPrice)) {
        $query->where('price', '>=', $minPrice);
        if (!empty($maxPrice)) {
            $query->where('price', '<=', $maxPrice);
        }
    }
}

if (!empty($keyword)) {
    $query->where(function($q) use ($keyword) {
        $q->where('name', 'like', "%$keyword%")
          ->orWhere('description', 'like', "%$keyword%");
    });
}

$products = $query->get();
```

**ä¼˜åŒ–åŽï¼ˆæ¡ä»¶åˆ†ç¦»ï¼‰ï¼š**

```php
// åˆå§‹åŒ–æŸ¥è¯¢
$query = DB::table('products');

// æå–æ¡ä»¶å˜é‡
$hasCategory = !empty($category);
$hasPriceRange = $hasCategory && !empty($minPrice);
$hasMaxPrice = $hasPriceRange && !empty($maxPrice);
$hasKeyword = !empty($keyword);

// åº”ç”¨åˆ†ç±»æ¡ä»¶
if ($hasCategory) {
    $query->where('category_id', $category);
    
    // åº”ç”¨ä»·æ ¼æ¡ä»¶
    if ($hasPriceRange) {
        $query->where('price', '>=', $minPrice);
        if ($hasMaxPrice) {
            $query->where('price', '<=', $maxPrice);
        }
    }
}

// åº”ç”¨å…³é”®è¯æœç´¢
if ($hasKeyword) {
    $query->where(function($q) use ($keyword) {
        $q->where('name', 'like', "%$keyword%")
          ->orWhere('description', 'like', "%$keyword%");
    });
}

$products = $query->get();
```

### ä¸€ã€**é€»è¾‘ç®€åŒ–ä¸Žæ¸…æ™°åŒ–**

1. **æ¶ˆé™¤åµŒå¥—æ¡ä»¶ï¼ˆå‡å°‘ if-else å±‚çº§ï¼‰**åµŒå¥—è¿‡æ·±çš„æ¡ä»¶åˆ¤æ–­ä¼šå¯¼è‡´ä»£ç  "æ¨ªå‘è”“å»¶"ï¼Œéš¾ä»¥ç†è§£ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   if ($user) {
       if ($user->isVip()) {
           if ($order->total >= 1000) {
               $discount = 0.8;
           } else {
               $discount = 0.9;
           }
       } else {
           $discount = 1.0;
       }
   } else {
       throw new Exception("æœªç™»å½•");
   }
   ```

   

   **ä¼˜åŒ–åŽ**ï¼ˆæå‰ return + æ‰å¹³åŒ–ï¼‰ï¼š

   ```php
   if (!$user) throw new Exception("æœªç™»å½•");
   if (!$user->isVip()) return 1.0;
   return $order->total >= 1000 ? 0.8 : 0.9;
   ```

   

2. **ç”¨ "å«è¯­å¥" æ›¿ä»£å¤æ‚æ¡ä»¶**å¯¹äºŽç‰¹æ®Šæƒ…å†µï¼Œæå‰è¿”å›žæˆ–æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…ä¸»é€»è¾‘è¢«åµŒå¥—ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   function calculatePrice($goods, $user) {
       if ($goods && $user && $user->status == 1) {
           // å¤æ‚çš„ä»·æ ¼è®¡ç®—é€»è¾‘...
           return $price;
       } else {
           return 0;
       }
   }
   ```

   

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   function calculatePrice($goods, $user) {
       if (!$goods) return 0;       // å«è¯­å¥ï¼šå•†å“ä¸å­˜åœ¨
       if (!$user) return 0;        // å«è¯­å¥ï¼šç”¨æˆ·ä¸å­˜åœ¨
       if ($user->status != 1) return 0;  // å«è¯­å¥ï¼šç”¨æˆ·çŠ¶æ€å¼‚å¸¸
       
       // ä¸»é€»è¾‘ï¼ˆæ— éœ€åµŒå¥—ï¼‰
       // å¤æ‚çš„ä»·æ ¼è®¡ç®—é€»è¾‘...
       return $price;
   }
   ```

   

### äºŒã€**å˜é‡ä¸Žè¡¨è¾¾å¼ä¼˜åŒ–**

1. **æå–é‡å¤è¡¨è¾¾å¼ä¸ºå˜é‡**é‡å¤å‡ºçŽ°çš„è¡¨è¾¾å¼ä¼šå¯¼è‡´ä¿®æ”¹æ—¶éœ€è¦å¤šå¤„åŒæ­¥ï¼Œä¸”é™ä½Žå¯è¯»æ€§ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   if ($order->create_time > strtotime('-30 days') && $order->status == 1 && $user->level >= 3) {
       // é€»è¾‘1
   }
   if ($order->create_time > strtotime('-30 days') && $order->status == 1 && $user->points > 1000) {
       // é€»è¾‘2
   }
   ```

   

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   $isRecentValidOrder = $order->create_time > strtotime('-30 days') && $order->status == 1;
   if ($isRecentValidOrder && $user->level >= 3) { /* é€»è¾‘1 */ }
   if ($isRecentValidOrder && $user->points > 1000) { /* é€»è¾‘2 */ }
   ```

   

2. **ç”¨å¸¸é‡ / æžšä¸¾æ›¿ä»£é­”æ³•å€¼**ç›´æŽ¥ä½¿ç”¨æ•°å­—ã€å­—ç¬¦ä¸²ç­‰ "é­”æ³•å€¼" ä¼šå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£ï¼Œä¿®æ”¹æ—¶æ˜“å‡ºé”™ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   if ($order->status == 2) {
       // å¤„ç†å·²å‘è´§è®¢å•
   }
   ```

   

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   // å®šä¹‰æžšä¸¾æˆ–å¸¸é‡
   class OrderStatus {
       const PENDING = 1;
       const SHIPPED = 2;
       const COMPLETED = 3;
   }
   
   if ($order->status == OrderStatus::SHIPPED) {
       // å¤„ç†å·²å‘è´§è®¢å•
   }
   ```

   

### ä¸‰ã€**å‡½æ•°ä¸Žæ–¹æ³•ä¼˜åŒ–**

1. **æ‹†åˆ†è¶…å¤§å‡½æ•°ï¼ˆå•ä¸€èŒè´£åŽŸåˆ™ï¼‰**ä¸€ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ï¼Œé¿å…å‡ ç™¾è¡Œçš„ "ä¸‡èƒ½å‡½æ•°"ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   function handleOrder($order) {
       // 1. éªŒè¯è®¢å•åˆæ³•æ€§ï¼ˆ50è¡Œï¼‰
       // 2. è®¡ç®—ä»·æ ¼ï¼ˆ30è¡Œï¼‰
       // 3. æ‰£å‡åº“å­˜ï¼ˆ20è¡Œï¼‰
       // 4. ç”Ÿæˆç‰©æµå•ï¼ˆ40è¡Œï¼‰
   }
   ```

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   function handleOrder($order) {
       $this->validateOrder($order);       // éªŒè¯
       $price = $this->calculatePrice($order);  // è®¡ç®—ä»·æ ¼
       $this->deductStock($order);         // æ‰£å‡åº“å­˜
       $this->createLogistics($order);     // ç”Ÿæˆç‰©æµå•
   }
   ```

   

2. **å‡å°‘å‡½æ•°å‚æ•°ï¼ˆæŽ§åˆ¶å‚æ•°æ•°é‡ï¼‰**è¿‡å¤šçš„å‚æ•°ä¼šå¯¼è‡´è°ƒç”¨æ—¶å®¹æ˜“ä¼ é”™é¡ºåºï¼Œå¯å°è£…ä¸ºå¯¹è±¡æˆ–æ•°ç»„ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   function createUser($name, $age, $email, $phone, $address, $role) {
       // ...
   }
   ```

   

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   class UserData {
       public $name;
       public $age;
       public $email;
       public $phone;
       public $address;
       public $role;
   }
   
   function createUser(UserData $data) {
       // ä½¿ç”¨ $data->name ç­‰
   }
   ```

   

### å››ã€**å¾ªçŽ¯ä¸Žè¿­ä»£ä¼˜åŒ–**

1. **å‡å°‘å¾ªçŽ¯å†…çš„è®¡ç®—**å¾ªçŽ¯å†…çš„é‡å¤è®¡ç®—ä¼šæµªè´¹æ€§èƒ½ï¼Œå°¤å…¶æ˜¯å¤§æ•°æ®é‡æ—¶ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   foreach ($products as $product) {
       if ($product->price > $maxPrice && $product->category == Category::ELECTRONICS) {
           // ...
       }
   }
   ```

   

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   $targetCategory = Category::ELECTRONICS;  // å¾ªçŽ¯å¤–è®¡ç®—ä¸€æ¬¡
   foreach ($products as $product) {
       if ($product->price > $maxPrice && $product->category == $targetCategory) {
           // ...
       }
   }
   ```

   

2. **æå‰ç»ˆæ­¢å¾ªçŽ¯**æ‰¾åˆ°ç›®æ ‡åŽç«‹å³ breakï¼Œé¿å…æ— æ•ˆè¿­ä»£ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   $hasStock = false;
   foreach ($products as $product) {
       if ($product->id == $targetId && $product->stock > 0) {
           $hasStock = true;
       }
   }
   ```

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   $hasStock = false;
   foreach ($products as $product) {
       if ($product->id == $targetId) {
           $hasStock = $product->stock > 0;
           break;  // æ‰¾åˆ°ç›®æ ‡åŽç«‹å³ç»ˆæ­¢
       }
   }
   ```

   

### äº”ã€**é”™è¯¯å¤„ç†ä¼˜åŒ–**

1. ç”¨å¼‚å¸¸æ›¿ä»£é”™è¯¯ç 

   

   é”™è¯¯ç éœ€è¦æ¯å±‚å‡½æ•°æ‰‹åŠ¨ä¼ é€’ï¼Œå¼‚å¸¸å¯ç›´æŽ¥æŠ›åˆ°ä¸Šå±‚å¤„ç†ã€‚

   ä¼˜åŒ–å‰:

   ```php
   function createOrder() {
       if (!$user) return -1;  // é”™è¯¯ç ï¼šç”¨æˆ·ä¸å­˜åœ¨
       if (!$product) return -2; // é”™è¯¯ç ï¼šå•†å“ä¸å­˜åœ¨
       // ...
   }
   
   // è°ƒç”¨æ—¶éœ€è¦åˆ¤æ–­æ¯ä¸ªé”™è¯¯ç 
   $result = createOrder();
   if ($result == -1) { /* å¤„ç†ç”¨æˆ·ä¸å­˜åœ¨ */ }
   else if ($result == -2) { /* å¤„ç†å•†å“ä¸å­˜åœ¨ */ }
   ```

   

   ä¼˜åŒ–åŽ

   ```php
   function createOrder() {
       if (!$user) throw new UserNotFoundException();
       if (!$product) throw new ProductNotFoundException();
       // ...
   }
   
   // è°ƒç”¨æ—¶é›†ä¸­å¤„ç†å¼‚å¸¸
   try {
       createOrder();
   } catch (UserNotFoundException $e) {
       /* å¤„ç†ç”¨æˆ·ä¸å­˜åœ¨ */
   } catch (ProductNotFoundException $e) {
       /* å¤„ç†å•†å“ä¸å­˜åœ¨ */
   }
   ```

   

### å…­ã€**ä»£ç å¤ç”¨ä¼˜åŒ–**

1. **æå–é‡å¤é€»è¾‘ä¸ºå…¬å…±æ–¹æ³•**å¤šå¤„å‡ºçŽ°çš„ç›¸åŒé€»è¾‘ï¼Œåº”å°è£…ä¸ºå…¬å…±å‡½æ•°æˆ–å·¥å…·ç±»ã€‚**ä¼˜åŒ–å‰**ï¼š

   ```php
   // é¡µé¢Açš„ä»·æ ¼æ ¼å¼åŒ–
   $priceA = number_format($rawPriceA, 2, '.', ',');
   // é¡µé¢Bçš„ä»·æ ¼æ ¼å¼åŒ–
   $priceB = number_format($rawPriceB, 2, '.', ',');
   ```

   

   **ä¼˜åŒ–åŽ**ï¼š

   ```php
   function formatPrice($price) {
       return number_format($price, 2, '.', ',');
   }
   
   $priceA = formatPrice($rawPriceA);
   $priceB = formatPrice($rawPriceB);
   ```

   

2. **ä½¿ç”¨è®¾è®¡æ¨¡å¼ç®€åŒ–å¤æ‚é€»è¾‘**ä¾‹å¦‚ç”¨ "ç­–ç•¥æ¨¡å¼" å¤„ç†å¤šå˜çš„ç®—æ³•ï¼Œç”¨ "å·¥åŽ‚æ¨¡å¼" å¤„ç†å¯¹è±¡åˆ›å»ºé€»è¾‘ç­‰ã€‚**ç¤ºä¾‹ï¼ˆç­–ç•¥æ¨¡å¼ä¼˜åŒ–æ”¯ä»˜é€»è¾‘ï¼‰**ï¼š

   ```php
   // ç­–ç•¥æŽ¥å£
   interface PaymentStrategy {
       function pay($amount);
   }
   
   // å…·ä½“å®žçŽ°ï¼ˆæ”¯ä»˜å®ã€å¾®ä¿¡ï¼‰
   class AlipayStrategy implements PaymentStrategy {
       function pay($amount) { /* æ”¯ä»˜å®æ”¯ä»˜é€»è¾‘ */ }
   }
   class WechatStrategy implements PaymentStrategy {
       function pay($amount) { /* å¾®ä¿¡æ”¯ä»˜é€»è¾‘ */ }
   }
   
   // ä½¿ç”¨æ—¶åŠ¨æ€é€‰æ‹©ç­–ç•¥
   $payment = new PaymentContext(new AlipayStrategy());
   $payment->executePay(100);
   ```