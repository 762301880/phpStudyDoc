##   如何将**explode**分割后的字符修改为<font color='green'>int</font>类型

**参考资料**

| 名称     | 地址                                                         |
| -------- | ------------------------------------------------------------ |
| 网络博客 | [link](https://blog.csdn.net/haibo0668/article/details/108534887?utm_term=php%20%E5%A4%84%E7%90%86%E6%95%B0%E7%BB%84%E7%9A%84%E5%80%BC%E5%8F%98%E6%88%90int%E5%9E%8B&utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~sobaiduweb~default-0-108534887-null-null&spm=3001.4430) [link](https://www.itranslater.com/qa/details/2120199784635040768) |

**说明**

> 今天开发过程中遇到问题,返回的处理前端说要 **int**类型不然不好处理,本来我也想到了**array_map**批量处理一下
>
> 写个闭包结果**map**中无法检测到闭包函数，查阅百度发现可以闭包直接填写**全局变量例如intval** ,**骚操作只能说**

**问题代码**

```php
# 解决之前   
   /**
    * explode('*', $list->arg_string_id)); 代码分割出来字符为中文例如:["205","206"]
    */
  return self::field('arg_string_id,price')->where('service_id', $service_id)
           ->select()
            ->map(function ($list) {
                $list->arg_id = explode('*', $list->arg_string_id)); 
            });
# 解决之后-修改之后返回: [205,206]
 $list->arg_id = !empty($list->arg_string_id) ? array_map('intval', explode('*', $list->arg_string_id)) : "";
```

## 判断时间是否存在交集

### 判断当前时间是否在某个时间段内

**代码示例**

```shell
 /**
     * 获取转化后的活动价格
     * 在后台添加了活动方案的字段，在活动时间内，突出展示活动价。过了活动时间，只展示标准价（具体看活动方案页）
     */
    public static function getCurrentChangeStandardPrice($service_id)
    {
        $self = self::where('service_id', $service_id)->find();//查询当前实例
        $currentTime = time();//当前时间
        $standard_price = $self->standard_price ?? 0;//标准价格

        $serviceActivitys = ServiceActivityModel::where($service_id, $service_id)->select();
        if (empty($serviceActivitys)) return $standard_price;
        foreach ($serviceActivitys as $element) {
            $start_time = strtotime($element->start_time);
            $end_time = strtotime($element->end_time);
            # 核心代码
            if ($currentTime >= $start_time && $currentTime <= $end_time) return $element->activity_price;
            continue;
        }
        return $standard_price;
    }
```

### 更好的判断二

```php
    /**
     * 计算时间是否有交集
     * @return bool
     * @throws \exception\SystemException
     */
    public static function diffActivityStartAndEnd($service_id, $insertStartTime, $insertEndTime): bool
    {

        $insertStartTime = self::formatDate($insertStartTime);
        $insertEndTime = self::formatDate($insertEndTime);
        if ($insertStartTime > $insertEndTime) throw new SystemException("录入的开始日期不能大于结束日期");
        $serviceActivityModels = self::where(['service_id' => $service_id])->select();
        if (empty($serviceActivityModels)) return true;
        foreach ($serviceActivityModels as $element) {
            $elementStartTime = self::formatDate($element->start_time);//当前模型开始的时间
            $elementEndTime = self::formatDate($element->end_time);//当前模型结束的时间
            if ($insertStartTime >= $elementStartTime && $insertStartTime <= $elementEndTime) return false;
            if ($insertEndTime >= $elementStartTime && $insertEndTime <= $elementEndTime) return false;
        }
        return true;
    }
    /**
     * @param $dataTime //序列化时间
     * @param string $format 时间格式
     * @param false $unixTimestamp 是否需要返回unix时间戳类型
     * @return int|string
     * @throws \Exception
     */
    protected static function formatDate($dataTime, $format = 'Y-m-d H:i', $unixTimestamp = false)
    {
        //判断传入的时间类型并序列化
        $formatDateTime = is_int($dataTime) ? date($format, $dataTime) : date($format, strtotime($dataTime));
        $dateTime = new \DateTime($formatDateTime);
        $data = $dateTime->format($format);
        if ($unixTimestamp) return $dateTime->getTimestamp();
        return $data;
    }

#---------------------------------------------调用--------------------------------------------------------------
    protected function isAllowAppendTime($value, $rule, $data = [])
    {
        $service_id = $data['service_id'] ?? "";
        $start_time = $data['start_time'] ?? "";
        $end_time = $data['end_time'] ?? "";
        if (ServiceActivityModel::diffActivityStartAndEnd($service_id, $start_time, $end_time) == false) throw new SystemException("活动方案时间与旧方案存在时间交集请重新选择方案时间");
        return true;
    }
```

## [PHP获取本周所有日期或者最近七天所有日期](https://blog.csdn.net/qq_32450471/article/details/125974483)





##  构建6*7的日历数据

![image-20230214112511445](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20230214112511445.png)

**代码示例**

```php
   
        $date = !empty($data['date']) ? $data['date'] : date('Y-m');//需要查询的日期
        #--------------------------------------------------------------------------#
        $start_date = date('Y-m-01', strtotime($date));//本月的第一天
        $first_date_week = date('N', strtotime($start_date));//本月第一天是周几
        $lastMonthSurplusDateNum = $first_date_week - 1 - 1;
        $last_month_start_date = date('Y-m-01', strtotime('-1 month', strtotime($start_date))); //上个月一号
        $last_month_end_date = date('t', strtotime($last_month_start_date)); //上个月最后一天
        $last_month_end_date = date("Y-m-{$last_month_end_date}", strtotime($last_month_start_date)); //上个月最后一天
        $generate_start_date = date('Y-m-d', strtotime("-{$lastMonthSurplusDateNum}day", strtotime($last_month_end_date)));
        $generate_end_date = date('Y-m-d', strtotime('+41 days', strtotime($generate_start_date)));
        $generateDates = $this->generateDateInterval($generate_start_date, $generate_end_date); //构建一个月的所有日期
        dd($generateDates);
       

# 生成构建日期函数
public function generateDateInterval($minimum_time, $maximum_time)
    {
        $collection = [];
        //循环计算
        $minimum_time = strtotime($minimum_time);
        $maximum_time = strtotime($maximum_time);
        while ($minimum_time <= $maximum_time) {
            $collection[] += $minimum_time;
            $minimum_time = strtotime('+1 day', $minimum_time);
        }
        foreach ($collection as &$value) {
            $value = date('Y-m-d', $value);
        }
        return $collection;
    }
```

## [静态方法怎么调用非静态变量](https://mip.yht7.com/news/114824)

> 总所周知,静态方法只能调用静态变量,但是有时候我们静态方法中想要调用非静态变量怎么办呢

```php
 $reserve_with_aunts_table_name=ReserveWithAuntsModel::getTableName(); //关联带单阿姨表表名 用于写原生sql leftjoin中添加动态表名



#  实现效果如下: 写一个静态方法,然后实例化自己再次调用变量即可
<?php
namespace app\common\model;
use think\Model;

class ReserveWithAuntsModel extends Model
{
    protected $table = 'pxs_reserve_with_aunts';
    public static function getTableName()
    {
        return (new self())->table??"";
    }
}
```

##  循环体中引用外部变量赋值会一直显示最后一个结果怎么办

>  这种情况很可能是因为 PHP 中的变量作用域问题导致的。
>
> 在 PHP 中，变量作用域指的是变量在代码中的可访问范围。如果一个变量在函数或循环体内部定义，那么它的作用域就被限制在该函数或循环体内部。如果在函数或循环体内部引用外部变量，则需要使用 `global` 关键字或将变量作为函数参数传递才能访问外部变量。
>
> 在循环体中引用外部变量赋值时，如果没有使用 `global` 关键字或将变量作为函数参数传递，循环体内的变量会被反复赋值，每次循环都会覆盖之前的值，最终只会保留最后一次循环的结果。
>
> 要解决这个问题，可以使用 `global` 关键字或将变量作为函数参数传递，确保在循环体内部引用外部变量时，使用的是同一个变量，而不是每次循环都创建一个新的变量。

  以下是使用 `global` 关键字的示例代码：

```php
$count = 0;

function test() {
    global $count;
    for ($i = 0; $i < 10; $i++) {
        $count = $i;
        echo $count . '<br>';
    }
}

test();
echo $count;
```

> 这段代码会输出：

```php
1
2
3
4
5
6
7
8
9
9
```

> 可以看到，`$count` 变量在循环体内部被赋值了 10 次，但最终输出的结果是最后一次赋值的结果。
>
> 如果在循环体内部不使用 `global` 关键字，代码会像这样：

```php
$count = 0;

function test() {
    for ($i = 0; $i < 10; $i++) {
        $count = $i;
        echo $count . '<br>';
    }
}

test();
echo $count;
```

> 这段代码会输出：

```php
1
2
3
4
5
6
7
8
9
0
```

> 可以看到，`$count` 变量在循环体内部被赋值了 10 次，但最终输出的结果是变量在循环体外部的初始值。这是因为在循环体内部创建了一个新的局部变量 `$count`，并且每次循环都会覆盖之前的值，最终只保留了最后一次循环的结果。

###  个人代码错误bug复现

```php
<?php

namespace App\Http\Controllers;


use App\Models\Stu;
use App\Traits\ApplyResponseLayout;
use Illuminate\Http\Request;


class TestController extends Controller
{
    use ApplyResponseLayout;
   
    public function test(Request $request)
    {
        $dates = [['date' => '2023-04-11'], ['date' => '2023-04-12'], ['date' => '2023-04-13']];
        $stu = Stu::all(); //问题出在这里 把这段代码转移到循环体中即可解决(问题是如果数据量大的情况下怎么办)
        foreach ($dates as $key => &$date) {

            $one_date = $date['date'] ?? "";
            $date['insert_datas'] = $stu->map(function ($list) use ($one_date) {
                $list->test = [
                    self::getDate($one_date),
                    self::getDate($one_date)
                ];
                return $list;
            });
        }
        return $this->success($dates);
    }

    public static function getDate($date)
    {
        $retData = [];
        $retData['date'] = $date;
        $retData['tishi'] = "你好";
        return $retData;
    }

}
```

**上诉代码输出错误结果**

```json
{
    "code": 200,
    "msg": [
        {
            "date": "2023-04-11",
            "insert_datas": [
                {
                    "id": 1,
                    "sname": "李广",
                    "class_id": 1,
                    "birthday": "1998-02-12 08:22:13",
                    "updated_at": "2019-07-20T06:22:16.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 2,
                    "sname": "何青",
                    "class_id": 1,
                    "birthday": "1985-07-22 18:19:13",
                    "updated_at": "2019-07-17T13:50:38.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 3,
                    "sname": "钱佳",
                    "class_id": 3,
                    "birthday": "1989-11-17 10:29:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 4,
                    "sname": "刘玉",
                    "class_id": 1,
                    "birthday": "1999-07-03 19:46:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 5,
                    "sname": "后盾人",
                    "class_id": 2,
                    "birthday": "2003-09-01 20:33:13",
                    "updated_at": "2019-07-20T08:41:32.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 6,
                    "sname": "张云",
                    "class_id": 3,
                    "birthday": "1996-09-01 20:33:13",
                    "updated_at": "2019-07-19T04:59:40.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 7,
                    "sname": "李风",
                    "class_id": 1,
                    "birthday": "2003-02-15 20:33:13",
                    "updated_at": "2019-07-20T06:30:02.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 8,
                    "sname": "李兰",
                    "class_id": 2,
                    "birthday": null,
                    "updated_at": "2019-07-19T04:50:07.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 9,
                    "sname": "李月",
                    "class_id": 1,
                    "birthday": null,
                    "updated_at": "2019-07-18T09:49:03.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 10,
                    "sname": "刘雷",
                    "class_id": null,
                    "birthday": "1996-11-08 20:33:13",
                    "updated_at": "2019-07-20T07:59:28.000000Z",
                    "sex": null,
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                }
            ]
        },
        {
            "date": "2023-04-12",
            "insert_datas": [
                {
                    "id": 1,
                    "sname": "李广",
                    "class_id": 1,
                    "birthday": "1998-02-12 08:22:13",
                    "updated_at": "2019-07-20T06:22:16.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 2,
                    "sname": "何青",
                    "class_id": 1,
                    "birthday": "1985-07-22 18:19:13",
                    "updated_at": "2019-07-17T13:50:38.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 3,
                    "sname": "钱佳",
                    "class_id": 3,
                    "birthday": "1989-11-17 10:29:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 4,
                    "sname": "刘玉",
                    "class_id": 1,
                    "birthday": "1999-07-03 19:46:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 5,
                    "sname": "后盾人",
                    "class_id": 2,
                    "birthday": "2003-09-01 20:33:13",
                    "updated_at": "2019-07-20T08:41:32.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 6,
                    "sname": "张云",
                    "class_id": 3,
                    "birthday": "1996-09-01 20:33:13",
                    "updated_at": "2019-07-19T04:59:40.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 7,
                    "sname": "李风",
                    "class_id": 1,
                    "birthday": "2003-02-15 20:33:13",
                    "updated_at": "2019-07-20T06:30:02.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 8,
                    "sname": "李兰",
                    "class_id": 2,
                    "birthday": null,
                    "updated_at": "2019-07-19T04:50:07.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 9,
                    "sname": "李月",
                    "class_id": 1,
                    "birthday": null,
                    "updated_at": "2019-07-18T09:49:03.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 10,
                    "sname": "刘雷",
                    "class_id": null,
                    "birthday": "1996-11-08 20:33:13",
                    "updated_at": "2019-07-20T07:59:28.000000Z",
                    "sex": null,
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                }
            ]
        },
        {
            "date": "2023-04-13",
            "insert_datas": [
                {
                    "id": 1,
                    "sname": "李广",
                    "class_id": 1,
                    "birthday": "1998-02-12 08:22:13",
                    "updated_at": "2019-07-20T06:22:16.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 2,
                    "sname": "何青",
                    "class_id": 1,
                    "birthday": "1985-07-22 18:19:13",
                    "updated_at": "2019-07-17T13:50:38.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 3,
                    "sname": "钱佳",
                    "class_id": 3,
                    "birthday": "1989-11-17 10:29:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 4,
                    "sname": "刘玉",
                    "class_id": 1,
                    "birthday": "1999-07-03 19:46:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 5,
                    "sname": "后盾人",
                    "class_id": 2,
                    "birthday": "2003-09-01 20:33:13",
                    "updated_at": "2019-07-20T08:41:32.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 6,
                    "sname": "张云",
                    "class_id": 3,
                    "birthday": "1996-09-01 20:33:13",
                    "updated_at": "2019-07-19T04:59:40.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 7,
                    "sname": "李风",
                    "class_id": 1,
                    "birthday": "2003-02-15 20:33:13",
                    "updated_at": "2019-07-20T06:30:02.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 8,
                    "sname": "李兰",
                    "class_id": 2,
                    "birthday": null,
                    "updated_at": "2019-07-19T04:50:07.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 9,
                    "sname": "李月",
                    "class_id": 1,
                    "birthday": null,
                    "updated_at": "2019-07-18T09:49:03.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 10,
                    "sname": "刘雷",
                    "class_id": null,
                    "birthday": "1996-11-08 20:33:13",
                    "updated_at": "2019-07-20T07:59:28.000000Z",
                    "sex": null,
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                }
            ]
        }
    ],
    "data": []
}
```

