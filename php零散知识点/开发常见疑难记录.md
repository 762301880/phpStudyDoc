##   如何将**explode**分割后的字符修改为<font color='green'>int</font>类型

**参考资料**

| 名称     | 地址                                                         |
| -------- | ------------------------------------------------------------ |
| 网络博客 | [link](https://blog.csdn.net/haibo0668/article/details/108534887?utm_term=php%20%E5%A4%84%E7%90%86%E6%95%B0%E7%BB%84%E7%9A%84%E5%80%BC%E5%8F%98%E6%88%90int%E5%9E%8B&utm_medium=distribute.pc_aggpage_search_result.none-task-blog-2~all~sobaiduweb~default-0-108534887-null-null&spm=3001.4430) [link](https://www.itranslater.com/qa/details/2120199784635040768) |

**说明**

> 今天开发过程中遇到问题,返回的处理前端说要 **int**类型不然不好处理,本来我也想到了**array_map**批量处理一下
>
> 写个闭包结果**map**中无法检测到闭包函数，查阅百度发现可以闭包直接填写**全局变量例如intval** ,**骚操作只能说**

**问题代码**

```php
# 解决之前   
   /**
    * explode('*', $list->arg_string_id)); 代码分割出来字符为中文例如:["205","206"]
    */
  return self::field('arg_string_id,price')->where('service_id', $service_id)
           ->select()
            ->map(function ($list) {
                $list->arg_id = explode('*', $list->arg_string_id)); 
            });
# 解决之后-修改之后返回: [205,206]
 $list->arg_id = !empty($list->arg_string_id) ? array_map('intval', explode('*', $list->arg_string_id)) : "";
```

## 判断时间是否存在交集

### 判断当前时间是否在某个时间段内

**代码示例**

```shell
 /**
     * 获取转化后的活动价格
     * 在后台添加了活动方案的字段，在活动时间内，突出展示活动价。过了活动时间，只展示标准价（具体看活动方案页）
     */
    public static function getCurrentChangeStandardPrice($service_id)
    {
        $self = self::where('service_id', $service_id)->find();//查询当前实例
        $currentTime = time();//当前时间
        $standard_price = $self->standard_price ?? 0;//标准价格

        $serviceActivitys = ServiceActivityModel::where($service_id, $service_id)->select();
        if (empty($serviceActivitys)) return $standard_price;
        foreach ($serviceActivitys as $element) {
            $start_time = strtotime($element->start_time);
            $end_time = strtotime($element->end_time);
            # 核心代码
            if ($currentTime >= $start_time && $currentTime <= $end_time) return $element->activity_price;
            continue;
        }
        return $standard_price;
    }
```

### 更好的判断二

```php
    /**
     * 计算时间是否有交集
     * @return bool
     * @throws \exception\SystemException
     */
    public static function diffActivityStartAndEnd($service_id, $insertStartTime, $insertEndTime): bool
    {

        $insertStartTime = self::formatDate($insertStartTime);
        $insertEndTime = self::formatDate($insertEndTime);
        if ($insertStartTime > $insertEndTime) throw new SystemException("录入的开始日期不能大于结束日期");
        $serviceActivityModels = self::where(['service_id' => $service_id])->select();
        if (empty($serviceActivityModels)) return true;
        foreach ($serviceActivityModels as $element) {
            $elementStartTime = self::formatDate($element->start_time);//当前模型开始的时间
            $elementEndTime = self::formatDate($element->end_time);//当前模型结束的时间
            if ($insertStartTime >= $elementStartTime && $insertStartTime <= $elementEndTime) return false;
            if ($insertEndTime >= $elementStartTime && $insertEndTime <= $elementEndTime) return false;
        }
        return true;
    }
    /**
     * @param $dataTime //序列化时间
     * @param string $format 时间格式
     * @param false $unixTimestamp 是否需要返回unix时间戳类型
     * @return int|string
     * @throws \Exception
     */
    protected static function formatDate($dataTime, $format = 'Y-m-d H:i', $unixTimestamp = false)
    {
        //判断传入的时间类型并序列化
        $formatDateTime = is_int($dataTime) ? date($format, $dataTime) : date($format, strtotime($dataTime));
        $dateTime = new \DateTime($formatDateTime);
        $data = $dateTime->format($format);
        if ($unixTimestamp) return $dateTime->getTimestamp();
        return $data;
    }

#---------------------------------------------调用--------------------------------------------------------------
    protected function isAllowAppendTime($value, $rule, $data = [])
    {
        $service_id = $data['service_id'] ?? "";
        $start_time = $data['start_time'] ?? "";
        $end_time = $data['end_time'] ?? "";
        if (ServiceActivityModel::diffActivityStartAndEnd($service_id, $start_time, $end_time) == false) throw new SystemException("活动方案时间与旧方案存在时间交集请重新选择方案时间");
        return true;
    }
```

## [PHP获取本周所有日期或者最近七天所有日期](https://blog.csdn.net/qq_32450471/article/details/125974483)





##  构建6*7的日历数据

![image-20230214112511445](https://gitee.com/yaolliuyang/blogImages/raw/master/blogImages/image-20230214112511445.png)

**代码示例**

```php
   
        $date = !empty($data['date']) ? $data['date'] : date('Y-m');//需要查询的日期
        #--------------------------------------------------------------------------#
        $start_date = date('Y-m-01', strtotime($date));//本月的第一天
        $first_date_week = date('N', strtotime($start_date));//本月第一天是周几
        $lastMonthSurplusDateNum = $first_date_week - 1 - 1;
        $last_month_start_date = date('Y-m-01', strtotime('-1 month', strtotime($start_date))); //上个月一号
        $last_month_end_date = date('t', strtotime($last_month_start_date)); //上个月最后一天
        $last_month_end_date = date("Y-m-{$last_month_end_date}", strtotime($last_month_start_date)); //上个月最后一天
        $generate_start_date = date('Y-m-d', strtotime("-{$lastMonthSurplusDateNum}day", strtotime($last_month_end_date)));
        $generate_end_date = date('Y-m-d', strtotime('+41 days', strtotime($generate_start_date)));
        $generateDates = $this->generateDateInterval($generate_start_date, $generate_end_date); //构建一个月的所有日期
        dd($generateDates);
       

# 生成构建日期函数
public function generateDateInterval($minimum_time, $maximum_time)
    {
        $collection = [];
        //循环计算
        $minimum_time = strtotime($minimum_time);
        $maximum_time = strtotime($maximum_time);
        while ($minimum_time <= $maximum_time) {
            $collection[] += $minimum_time;
            $minimum_time = strtotime('+1 day', $minimum_time);
        }
        foreach ($collection as &$value) {
            $value = date('Y-m-d', $value);
        }
        return $collection;
    }
```

## [静态方法怎么调用非静态变量](https://mip.yht7.com/news/114824)

> 总所周知,静态方法只能调用静态变量,但是有时候我们静态方法中想要调用非静态变量怎么办呢

```php
 $reserve_with_aunts_table_name=ReserveWithAuntsModel::getTableName(); //关联带单阿姨表表名 用于写原生sql leftjoin中添加动态表名



#  实现效果如下: 写一个静态方法,然后实例化自己再次调用变量即可
<?php
namespace app\common\model;
use think\Model;

class ReserveWithAuntsModel extends Model
{
    protected $table = 'pxs_reserve_with_aunts';
    public static function getTableName()
    {
        return (new self())->table??"";
    }
}
```

##  循环体中引用外部变量赋值会一直显示最后一个结果怎么办

>  这种情况很可能是因为 PHP 中的变量作用域问题导致的。
>
> 在 PHP 中，变量作用域指的是变量在代码中的可访问范围。如果一个变量在函数或循环体内部定义，那么它的作用域就被限制在该函数或循环体内部。如果在函数或循环体内部引用外部变量，则需要使用 `global` 关键字或将变量作为函数参数传递才能访问外部变量。
>
> 在循环体中引用外部变量赋值时，如果没有使用 `global` 关键字或将变量作为函数参数传递，循环体内的变量会被反复赋值，每次循环都会覆盖之前的值，最终只会保留最后一次循环的结果。
>
> 要解决这个问题，可以使用 `global` 关键字或将变量作为函数参数传递，确保在循环体内部引用外部变量时，使用的是同一个变量，而不是每次循环都创建一个新的变量。

  以下是使用 `global` 关键字的示例代码：

```php
$count = 0;

function test() {
    global $count;
    for ($i = 0; $i < 10; $i++) {
        $count = $i;
        echo $count . '<br>';
    }
}

test();
echo $count;
```

> 这段代码会输出：

```php
1
2
3
4
5
6
7
8
9
9
```

> 可以看到，`$count` 变量在循环体内部被赋值了 10 次，但最终输出的结果是最后一次赋值的结果。
>
> 如果在循环体内部不使用 `global` 关键字，代码会像这样：

```php
$count = 0;

function test() {
    for ($i = 0; $i < 10; $i++) {
        $count = $i;
        echo $count . '<br>';
    }
}

test();
echo $count;
```

> 这段代码会输出：

```php
1
2
3
4
5
6
7
8
9
0
```

> 可以看到，`$count` 变量在循环体内部被赋值了 10 次，但最终输出的结果是变量在循环体外部的初始值。这是因为在循环体内部创建了一个新的局部变量 `$count`，并且每次循环都会覆盖之前的值，最终只保留了最后一次循环的结果。

###  个人代码错误bug复现

```php
<?php

namespace App\Http\Controllers;


use App\Models\Stu;
use App\Traits\ApplyResponseLayout;
use Illuminate\Http\Request;


class TestController extends Controller
{
    use ApplyResponseLayout;
   
    public function test(Request $request)
    {
        $dates = [['date' => '2023-04-11'], ['date' => '2023-04-12'], ['date' => '2023-04-13']];
        $stu = Stu::all(); //问题出在这里 把这段代码转移到循环体中即可解决(问题是如果数据量大的情况下怎么办)
        foreach ($dates as $key => &$date) {

            $one_date = $date['date'] ?? "";
            $date['insert_datas'] = $stu->map(function ($list) use ($one_date) {
                $list->test = [
                    self::getDate($one_date),
                    self::getDate($one_date)
                ];
                return $list;
            });
        }
        return $this->success($dates);
    }

    public static function getDate($date)
    {
        $retData = [];
        $retData['date'] = $date;
        $retData['tishi'] = "你好";
        return $retData;
    }

}
```

**上诉代码输出错误结果**

```json
{
    "code": 200,
    "msg": [
        {
            "date": "2023-04-11",
            "insert_datas": [
                {
                    "id": 1,
                    "sname": "李广",
                    "class_id": 1,
                    "birthday": "1998-02-12 08:22:13",
                    "updated_at": "2019-07-20T06:22:16.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 2,
                    "sname": "何青",
                    "class_id": 1,
                    "birthday": "1985-07-22 18:19:13",
                    "updated_at": "2019-07-17T13:50:38.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 3,
                    "sname": "钱佳",
                    "class_id": 3,
                    "birthday": "1989-11-17 10:29:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 4,
                    "sname": "刘玉",
                    "class_id": 1,
                    "birthday": "1999-07-03 19:46:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 5,
                    "sname": "后盾人",
                    "class_id": 2,
                    "birthday": "2003-09-01 20:33:13",
                    "updated_at": "2019-07-20T08:41:32.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 6,
                    "sname": "张云",
                    "class_id": 3,
                    "birthday": "1996-09-01 20:33:13",
                    "updated_at": "2019-07-19T04:59:40.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 7,
                    "sname": "李风",
                    "class_id": 1,
                    "birthday": "2003-02-15 20:33:13",
                    "updated_at": "2019-07-20T06:30:02.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 8,
                    "sname": "李兰",
                    "class_id": 2,
                    "birthday": null,
                    "updated_at": "2019-07-19T04:50:07.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 9,
                    "sname": "李月",
                    "class_id": 1,
                    "birthday": null,
                    "updated_at": "2019-07-18T09:49:03.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 10,
                    "sname": "刘雷",
                    "class_id": null,
                    "birthday": "1996-11-08 20:33:13",
                    "updated_at": "2019-07-20T07:59:28.000000Z",
                    "sex": null,
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                }
            ]
        },
        {
            "date": "2023-04-12",
            "insert_datas": [
                {
                    "id": 1,
                    "sname": "李广",
                    "class_id": 1,
                    "birthday": "1998-02-12 08:22:13",
                    "updated_at": "2019-07-20T06:22:16.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 2,
                    "sname": "何青",
                    "class_id": 1,
                    "birthday": "1985-07-22 18:19:13",
                    "updated_at": "2019-07-17T13:50:38.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 3,
                    "sname": "钱佳",
                    "class_id": 3,
                    "birthday": "1989-11-17 10:29:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 4,
                    "sname": "刘玉",
                    "class_id": 1,
                    "birthday": "1999-07-03 19:46:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 5,
                    "sname": "后盾人",
                    "class_id": 2,
                    "birthday": "2003-09-01 20:33:13",
                    "updated_at": "2019-07-20T08:41:32.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 6,
                    "sname": "张云",
                    "class_id": 3,
                    "birthday": "1996-09-01 20:33:13",
                    "updated_at": "2019-07-19T04:59:40.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 7,
                    "sname": "李风",
                    "class_id": 1,
                    "birthday": "2003-02-15 20:33:13",
                    "updated_at": "2019-07-20T06:30:02.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 8,
                    "sname": "李兰",
                    "class_id": 2,
                    "birthday": null,
                    "updated_at": "2019-07-19T04:50:07.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 9,
                    "sname": "李月",
                    "class_id": 1,
                    "birthday": null,
                    "updated_at": "2019-07-18T09:49:03.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 10,
                    "sname": "刘雷",
                    "class_id": null,
                    "birthday": "1996-11-08 20:33:13",
                    "updated_at": "2019-07-20T07:59:28.000000Z",
                    "sex": null,
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                }
            ]
        },
        {
            "date": "2023-04-13",
            "insert_datas": [
                {
                    "id": 1,
                    "sname": "李广",
                    "class_id": 1,
                    "birthday": "1998-02-12 08:22:13",
                    "updated_at": "2019-07-20T06:22:16.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 2,
                    "sname": "何青",
                    "class_id": 1,
                    "birthday": "1985-07-22 18:19:13",
                    "updated_at": "2019-07-17T13:50:38.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 3,
                    "sname": "钱佳",
                    "class_id": 3,
                    "birthday": "1989-11-17 10:29:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 4,
                    "sname": "刘玉",
                    "class_id": 1,
                    "birthday": "1999-07-03 19:46:13",
                    "updated_at": "2019-07-17T12:54:14.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 5,
                    "sname": "后盾人",
                    "class_id": 2,
                    "birthday": "2003-09-01 20:33:13",
                    "updated_at": "2019-07-20T08:41:32.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 6,
                    "sname": "张云",
                    "class_id": 3,
                    "birthday": "1996-09-01 20:33:13",
                    "updated_at": "2019-07-19T04:59:40.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 7,
                    "sname": "李风",
                    "class_id": 1,
                    "birthday": "2003-02-15 20:33:13",
                    "updated_at": "2019-07-20T06:30:02.000000Z",
                    "sex": "男",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 8,
                    "sname": "李兰",
                    "class_id": 2,
                    "birthday": null,
                    "updated_at": "2019-07-19T04:50:07.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 9,
                    "sname": "李月",
                    "class_id": 1,
                    "birthday": null,
                    "updated_at": "2019-07-18T09:49:03.000000Z",
                    "sex": "女",
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                },
                {
                    "id": 10,
                    "sname": "刘雷",
                    "class_id": null,
                    "birthday": "1996-11-08 20:33:13",
                    "updated_at": "2019-07-20T07:59:28.000000Z",
                    "sex": null,
                    "created_at": null,
                    "test": [
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        },
                        {
                            "date": "2023-04-13",
                            "tishi": "你好"
                        }
                    ]
                }
            ]
        }
    ],
    "data": []
}
```

### 修改后的逻辑

```php
<?php

namespace App\Http\Controllers;


use App\Models\Stu;
use App\Traits\ApplyResponseLayout;
use Illuminate\Http\Request;


class TestController extends Controller
{
    use ApplyResponseLayout;

    public function test(Request $request)
    {
        $dates = [['date' => '2023-04-11'], ['date' => '2023-04-12'], ['date' => '2023-04-13']];
        $stu = function (){
           return Stu::all();
        }; //问题出在这里
        foreach ($dates as $key => &$date) {

            $one_date = $date['date'] ?? "";
            $date['insert_datas'] = $stu()->map(function ($list) use ($one_date) {
                $list->test = [
                    self::getDate($one_date),
                    self::getDate($one_date)
                ];
                return $list;
            });
        }
        return $this->success($dates);
    }

    public static function getDate($date)
    {
        $retData = [];
        $retData['date'] = $date;
        $retData['tishi'] = "你好";
        return $retData;
    }

}

```

**chatjpt给我解决的方案**

```php
<?php

namespace App\Http\Controllers;


use App\Models\Stu;
use App\Traits\ApplyResponseLayout;
use Illuminate\Http\Request;


class TestController extends Controller
{
    use ApplyResponseLayout;

    public function test(Request $request)
    {
        /**
         * 首先，您使用的是 Laravel 框架，那么可以使用 Collection 类提供的一系列函数方法处理数据，
         * 其中，map() 与 transform() 两个方法都可以遍历集合并返回一个新的集合，两个方法的差别在于：map() 遍历集合并执行回调函数来对每个元素进行处理，
         * 最后返回一个新的集合；而 transform() 方法接收一个回调函数，用于对集合中的每个元素进行修改，并返回修改后的原始集合。
         * 在您所提供的代码中，使用的是 transform() 方法，正是因为 transform() 方法会直接修改原始集合，所以 $all 集合中的每个元素都被修改了，最后导致您所说的结果。
         * 如果您所期望的行为是，每次创建一个新的模型实例，而不是更新现有模型实例，那么可以使用 map() 方法来遍历 $all，并为每个模型新创建实例。具体代码如下： 示例代码
         * 在上述代码中，使用了 $all->map() 遍历集合，此时不再是对原集合的修改，
         * 而是从原集合的每个元素中新创建一个 model 实例。新建 model 实例通过将原 model 元素的 toArray() 方法获取到元素的数据，
         * 然后新建一个 model 实例进行保存。在回调函数中用属性 test 覆盖赋值，确保了存储属性数据都是唯一的值。
         */
        $dates = [['date' => '2023-04-11'], ['date' => '2023-04-12'], ['date' => '2023-04-13']];
        $all = Stu::all();
        foreach ($dates as $key => &$date) {
            $one_date = $date['date'] ?? "";
            $date['insert_datas'] = $all->map(function ($list) use ($one_date) {
                $newModel = new Stu($list->toArray());
                $newModel->test = [
                    self::getDate($one_date),
                    self::getDate($one_date),
                ];
                return $newModel;
            });
        }
        return $this->success($dates);
    }

    public static function getDate($date)
    {
        $retData = [];
        $retData['date'] = $date;
        $retData['tishi'] = "你好";
        return $retData;
    }

}
```



##  删除bom字符 "\ufeffSUCC"   

> **场景**
>
> 第三方支付给我发送通知  我需要给[第三方](https://docs.msfpay.com/docs/ztkx-cas//43)返回**SUCC** 字样,但是还是一直给我重复的通知经过与第三方沟通排查会发现人家接收的数据为**<feff>SUCC** 
>
> 百度一番之后发现  **feff**  是[**bom字符**](https://baike.baidu.com/item/BOM/2790401)   但是经过各种转化之后发现并未发现自己的业务逻辑中存在bom字符 ,期间尝试通过转化最终返回结果 为**uft8**字符格式,不管怎么弄都是返回包含bom字符的结果

**场景复现**

> 以下业务逻辑中**$obj->Sm2DecryptLajp** 引用了一个**php_java.php**的文件包含**bom**标记  
>
> 通过**grep -rl $'\xEF\xBB\xBF' .** 命令可以查询包含**bom标记的文件**

```php
$successResponse = 'SUCC';//成功返回信息
        $errorResponse = 'FAIL';//失败返回信息
        $data = request()->param();
        Log::info("订单支付回调信息为:" . json_encode($data));
        $obj = new Lajp();
        $encodeData = $data['data'] ?? ""; //返回加密数据
        $decodeData = $obj->Sm2DecryptLajp($encodeData); //解密后的数据
        $res = json_decode($decodeData, true);
        Log::info("订单支付回调解密的数据为:" . json_encode($res));

        $head = $res['message']['data']['head'] ?? "";
        $respcode = $head['respcode'] ?? ""; //C000000000  成功码
        $tranflow = $head['tranflow'] ?? "";
        //$body = $res['message']['data']['body'] ?? "";
        //$chlFinishTime = $body['chlFinishTime'] ?? "";

        if ($respcode == 'C000000000') { //成功情况下
            //先校验是否支付成功
            $isPayData = ZhongTouService::getInstance()->getOrderPayStatus($tranflow);
            $res = $obj->checkResult($isPayData);
            $statusData = $res['data'] ?? "";
            $oritranstatus = $statusData['oritranstatus'] ?? "";
            if ($oritranstatus == '01') { //支付成功后的回调
                //添加中投日志信息
                $zhongTouLogModel = ZhongTouLogModel::where('tranflow', $tranflow)->find();
                ++$zhongTouLogModel->callback_num;
                if (!empty($data)) $zhongTouLogModel->callback_info = json_encode($data);
                $zhongTouLogModel->save();//自增回调通知次数
                //订单信息查询
                $orderId = $zhongTouLogModel->order_id ?? "";
                $orderModel = OrderDao::getInstance($orderId);//查询订单实例
                if ($orderModel->status >= OrderModel::STATUS_IN_PRODUCTION) {//如果状态已经支付过返回成功
                    return $successResponse;
                }
                OrderService::getInstance()->orderPaySuccessEvent($orderModel, $tranflow); //修改订单支付成功回调
                return $successResponse;
            }
        }
        return $errorResponse;
```

**调用逻辑**

```php
  public function test(Request $request)
    {
        $url="https://sbt.51wpu.com.cn/api/order/notice";
        $text=file_get_contents($url);
        dd($text);
    }
# 打印结果显示  "\ufeffSUCC" 
```

**解决方案**

> 查询包含**bom** 字符的文件进行修改

```shell


# 删除bom字符
sed -i '1s/^\xef\xbb\xbf//' your_file.php

# 在Linux中查询PHP文件是否包含BOM字符可以使用命令行工具来完成，例如使用grep命令。下面是一个示例命令：
## 上述命令将递归地搜索/path/to/php/files目录下的所有PHP文件，并打印出包含BOM字符（UTF-8的BOM字符为\xEF\xBB\xBF）的文件路径。
## 如果输出为空，则表示目录下的PHP文件不包含BOM字符，否则，输出会列出包含BOM字符的文件路径。
## 请根据你的实际需求修改/path/to/php/files为你的PHP文件所在的目录路径。
grep -rl $'\xEF\xBB\xBF' /path/to/php/files
```

## 二维数组做筛选不为0的数据

> PHP的逻辑操作符和数组函数来筛选保留数据不为0的数据。下面是一个简单的示例代码：
>
> 该代码使用`array_filter`函数和匿名函数来筛选数据，只保留有至少一个值不为"0"的数组项。结果数组`$filteredData`将只包含保留的数据项。你可以根据需要进一步处理或使用该数组。

```php
$data = [
    [
        "staff_name" => "服务客服部F06",
        "now_staff_time_long" => "0",
        "now_chat_time_long" => "0",
        "chat_count" => "0",
        "chat_valid_count" => "0",
        "staff_chat_goods_count" => "0",
        "reply_num" => "0",
        "reply_all" => "0",
        "reply_ave" => 0.0,
        "ave_chat_time_long" => "0"
    ],
    [
        "staff_name" => "服务客服部F06",
        "now_staff_time_long" => "0",
        "now_chat_time_long" => "0",
        "chat_count" => "0",
        "chat_valid_count" => "0",
        "staff_chat_goods_count" => "0",
        "reply_num" => "0",
        "reply_all" => "0",
        "reply_ave" => 0.0,
        "ave_chat_time_long" => "1"
    ]
];

$filteredData = array_filter($data, function($item) {
    $values = array_values($item);
    foreach($values as $value) {
        if ($value !== "0") {
            return true;
        }
    }
    return false;
});

print_r($filteredData);
```

##  测试代码的执行时间

> 要查询PHP代码的请求时间，可以使用`microtime()`函数。`microtime()`函数返回当前 Unix 时间戳和微秒数。以下是一个示例：

```php
<?php
// 获取开始时间
$start_time = microtime(true);

// 要执行的代码
// ...

// 获取结束时间
$end_time = microtime(true);

// 计算并输出请求时间
$request_time = $end_time - $start_time;
echo "请求时间： " . $request_time . " 秒";
?>
```

##  php 方法中  使用&  传参是什么意思

> 在 PHP 中，使用 `&` 符号传递参数表示将参数作为引用传递而不是传递其值的副本。这意味着，如果你在函数内部修改了传递的参数，那么在函数外部的原始变量也会受到影响。
>
> 下面是一个示例来说明这个概念：

```php
function double(&$num) {
    $num *= 2;
}

$value = 10;
double($value);
echo $value;  // 输出 20 
```

> 在这个例子中，`double` 函数接受一个参数 `$num`，并且在函数内部将其值乘以 2。由于 `$num` 被传递为引用（使用 `&` 符号），在函数内部的修改会直接影响到原始变量 `$value`。
>
> 需要注意的是，传递引用可能会导致意想不到的行为，特别是在大型或复杂的程序中。因此，通常建议尽量避免过度使用引用传递，以免出现难以调试的问题。

##  获取用户请求终端

> 开发过程中我们需要 需要判断请求是来自那个终端 app还是 小程序  或者后台

### 方法一(通过请求头判断)

```php
// app/Http/Middleware/DetectDeviceOS.php
public function handle($request, Closure $next)
{
    $userAgent = $request->header('User-Agent');
    $os = 'unknown';

    if (stripos($userAgent, 'Android') !== false) {
        $os = 'android';
    } elseif (stripos($userAgent, 'iPhone') !== false || stripos($userAgent, 'iPad') !== false) {
        $os = 'ios';
    }

    // 将设备信息添加到请求中，供后续使用
    $request->merge(['device_os' => $os]);

    return $next($request);
}
```

### 方法二自定义请求头

> 前端加一个请求来源
>
> android  **安卓**
>
> mini-program/ xcx   **小程序**
>
> backend  **后台**

```php
 header: {
    'X-Requested-From': 'xcx'
  },  
 # 或者
 header: {
    'X-Client-Type': 'xcx'
  }, 
```

##  枚举数值使用

###  为什么要用枚举

> 避免了散落在代码中的重复字符串，统一管理  统一修改 排查
>
> 当需求变更时，你只需要改一处，例如状态从字符串变为数字，只需改枚举类，而不是在几十个文件里找 `'enabled'` 字符串。
>
> 代码更具语义性（可读性提升）

### 一、自定义枚举类型的典型使用场景

#### 1. 限定变量的合法取值范围（类型安全）

```php
class UserStatus {
    const ACTIVE = 'active';
    const INACTIVE = 'inactive';
    const BANNED = 'banned';
}

// 用例
$status = UserStatus::ACTIVE;
```

> 避免硬编码字符串，统一维护，减少出错。

#### 2. 数据库字段的值映射

用于映射数据库中某个字段的可选值，如订单状态、支付方式等：

```php
class OrderStatus {
    const PENDING = 0;
    const PAID = 1;
    const SHIPPED = 2;
    const COMPLETED = 3;
}
```

#### 3. 与前端交互的枚举转标签

结合静态方法返回可读性更强的映射。

```php
class OrderStatus {
    const PENDING = 0;
    const PAID = 1;
    const SHIPPED = 2;
    const COMPLETED = 3;

    public static function getLabel($status) {
        return match ($status) {
            self::PENDING => '待付款',
            self::PAID => '已付款',
            self::SHIPPED => '已发货',
            self::COMPLETED => '已完成',
            default => '未知',
        };
    }
}

// echo OrderStatus::getLabel(OrderStatus::PAID); // 输出：已付款
```

### 二、自定义枚举的几种实现方式

####  推荐方式：使用 `final class` + 常量 + 静态方法

```php
final class Gender {
    const MALE = 'male';
    const FEMALE = 'female';

    public static function all(): array {
        return [
            self::MALE,
            self::FEMALE,
        ];
    }

    public static function isValid($value): bool {
        return in_array($value, self::all(), true);
    }
}
```

#### 进阶：带名称和描述的枚举（更像字典）

```php
class PaymentMethod {
    const WECHAT = 'wechat';
    const ALIPAY = 'alipay';

    public static function all(): array {
        return [
            self::WECHAT => '微信支付',
            self::ALIPAY => '支付宝支付',
        ];
    }

    public static function getLabel(string $value): string {
        return self::all()[$value] ?? '未知';
    }
}

```

### 三、补充：使用 trait 封装通用枚举逻辑（可复用）

```php
trait EnumTrait {
    public static function values(): array {
        $class = new ReflectionClass(static::class);
        return array_values($class->getConstants());
    }

    public static function isValid($value): bool {
        return in_array($value, static::values(), true);
    }
}
```

然后枚举类中使用：

```php
final class UserRole {
    use EnumTrait;

    const ADMIN = 'admin';
    const USER = 'user';
    const GUEST = 'guest';
}
```

###  四 、数据库字典中枚举类型如何封装

**例如我们有以下统一管理的枚举数据库**

```sql
CREATE TABLE `pxs_asset_more` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `type` varchar(30) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '类型',
  `parent_id` bigint(20) NOT NULL DEFAULT '0' COMMENT '上一级id',
  `title` varchar(255) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '后台维护名',
  `label` varchar(50) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '显示名称',
  `value` varchar(30) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '字段值',
  `field` varchar(50) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '字段',
  `search_field` varchar(50) COLLATE utf8mb4_bin DEFAULT NULL COMMENT '搜索字段',
  `tab` varchar(50) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '表名(不含前缀)',
  `create_time` datetime DEFAULT NULL,
  `update_time` datetime DEFAULT NULL,
  `sort` float NOT NULL DEFAULT '1000' COMMENT '排序',
  `status` tinyint(1) NOT NULL DEFAULT '0' COMMENT '0正常1停用',
  `remark` varchar(255) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '备注',
  `action` tinyint(1) NOT NULL DEFAULT '0' COMMENT '1是动态分配，0静态',
  PRIMARY KEY (`id`),
  KEY `pxs_asset_more_value_index` (`value`),
  KEY `pxs_asset_more_type_index` (`type`)
) ENGINE=InnoDB AUTO_INCREMENT=609 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin ROW_FORMAT=DYNAMIC COMMENT='多级字典';
```

**处理**

使用直接  示例 虽然并不优雅但是实现了可以全局查询

> `AssetMoreDao::getLabelByValue('follow_stage','3');`
>
> `AssetMoreDao::getLabelByValues('msg_type',['3','5','6']));`

```php
   
    public static function getLabelByValue($type, $value)
    {
        return $value;
    }


public static function getLabelByValues($type, $values = array())
    {
        return $values;
    }
```

## [PHP大数组内存优化，使用yield实现高效生成与遍历](https://mp.weixin.qq.com/s/X0efwXaDLLfkBZOLJJP_Mg)

### **传统数组生成的内存问题**

在PHP中，当我们需要处理大量数据时，传统的数组生成方式会带来显著的内存消耗。让我们通过一个例子来观察这个问题：

```php
/**
 * 传统方式生成大数组的内存消耗测试
 */
$startMemory=memory_get_usage();

// 生成一个包含1,000,000个元素的数组
$arr=range(0,1000000);

$endMemory=memory_get_usage();

echo round(($endMemory-$startMemory)/1024/1024,2).' MB'.PHP_EOL;
```

**测试结果**：

```shell
34MB
```

这种传统方式会一次性在内存中创建完整的数组，当数据量很大时（如百万级或更多），会消耗大量内存。在高并发场景下，这很容易导致内存不足的错误。

**生成器(yield)解决方案**

PHP的生成器提供了一种优雅的解决方案，它不会一次性生成所有数据，而是按需生成，从而极大减少内存使用。

#### 生成器实现原理

```php
/**
 * 使用生成器构造数据序列
 * @paramint$start 起始值
 * @paramint$end 结束值
 * @paramint$step 步长
 * @returnGenerator
 */
function xrange($start,$end,$step=1)
{
for($i=$start;$i<$end;$i+=$step){
// 使用yield逐个返回值，而不是构建完整数组
yield$i;
}
```

#### 内存消耗测试

```php
$startMemory=memory_get_usage();

// 遍历生成器产生的值
foreach(xrange(0,1000000)as$item){
// 这里可以处理每个元素
echo$item.'<br />';
}

$endMemory=memory_get_usage();

echoround(($endMemory-$startMemory)/1024/1024,2).' MB'.PHP_EOL;
```

**测试结果**：

```php
0MB
```

### **为什么生成器如此高效？**

**惰性计算**

生成器只在需要时才产生值，不会预先计算所有结果

**状态保持**

生成器在yield时会保存当前状态，下次调用时从中断处继续

**内存友好**

同一时间只有一个值保存在内存中，而不是整个数据集

### **实际应用场景**

生成器特别适合以下场景：

1. 处理大型数据集（如日志文件、数据库结果集）
2. 实现高效的迭代器
3. 生成无限序列（如斐波那契数列）
4. 流式处理数据（如CSV文件导出）

### **进阶用法**

#### 带键值的生成器

```php
function keyValueGenerator(){
yield'name'=>'John';
yield'age'=>30;
yield'city'=>'New York';
}

foreach(keyValueGenerator() as $key=>$value){
  echo"$key: $value<br>";
}
```

