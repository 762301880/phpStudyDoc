

##  leftjoin   之后如何获取最后一条数据

> 我们经常需要连表查询一些数据但是当A表(用户信息表一个用户只有一条信息)连接B表
>
> (文章表一个用户可以有多个文章), 时候**leftJoin** 会发现产生了很多条A表数据,因为B表重复
>
> 但是我们只想要一条B表数据(及文章表**B表**)最后一篇文章	

**参考资料**

| 名称       | 地址                                                         |
| ---------- | ------------------------------------------------------------ |
| 第三方博客 | [link](https://blog.csdn.net/weixin_33117513/article/details/113265284?spm=1001.2101.3001.6650.13&utm_medium=distribute.wap_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-13.wap_blog_relevant_default&depth_1-utm_source=distribute.wap_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-13.wap_blog_relevant_default) |
|            |                                                              |

**sql示例**

**学生表**

![image-20220124081745490](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20220124081745490.png)

**文章表**

![image-20220124082054321](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20220124082054321.png)

> 需求就是,我要获取一个学生的发布的最后一片文章的名称还有**click**点击数,如果要获取最新的一条把**MAX()**函数修改为**MIN()**函数即可
>
> ，本来我从网上找的 any_value()函数也是可以实现第一条获取,没有这个好扩展

![image-20220124082702007](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20220124082702007.png)

> 运用子查询 先查询符合条件的id，再下一步
>
> 一般在子查询中，程序先运行在嵌套在最内层的语句，再运行外层。因此在写子查询语句时，可以先测试下内层的子查询语句是否输出了想要的内容，再一层层往外测试，增加子查询正确率。否则多层的嵌套使语句可读性很低。

```sql
# 代码示例 
SELECT
	* 
FROM
	`stu`
	LEFT JOIN (
	SELECT
		* 
	FROM
		article 
WHERE
	id IN ( SELECT MAX( id ) FROM article GROUP BY stu_id )) AS article ON stu.id = article.stu_id
#  选取个别字段

# 其他项目中的代码示例(laravel写法)
 $query->leftJoin(\DB::raw('(select *  from  hr_user_follows where id in (select max(id) from hr_user_follows GROUP BY user_id)) AS follows'), \DB::raw('follows.user_id'), \DB::raw('user.id'));
```

## [mysql 按照姓名排序](https://blog.csdn.net/weixin_33037089/article/details/113612181)

> 突发奇想如果有一天我需要做一个项目要按照姓式 排序怎么办，例如  **阿华,张三,王五,阿斌,张心儿** 这种排序出来
>
> **阿华,阿斌,王五,张三,张心儿** 这种排序出来,一开始我还没做的时候想的是是不是要把mysql中的读取的字符转化为
>
> 英文首字母大小写排序或者用第三方的扩展包转化为拼音排序,万事不懂先百度,人家mysql贴心自带了这种排序所以
>
> 不需要我们想的太复杂

**sql数据结构**

![stu.png](https://s2.loli.net/2022/03/13/QbinyGkERLUC4j7.png)

**对应sql**

```mysql
# 第一种排序 推荐          
# CONVERT(name USING gbk)函数将字符串 name 的字符集变成 gbk,函数查看 https://www.runoob.com/mysql/mysql-functions.html

SELECT * FROM `stu` ORDER BY CONVERT(sname USING gbk)  # 正序排列 a 字母名称在最开始

SELECT * FROM `stu` ORDER BY CONVERT(sname USING gbk) desc  # 倒序排列 z 字母名称在最开始

# 第二种排序
SELECT * FROM `stu` ORDER BY sname asc # 正序排列 a 字母名称在最开始

SELECT * FROM `stu` ORDER BY sname desc # 倒序排列 z 字母名称在最开始
```

##  **关于json字段插入数据不能为空的问题**

> 插入字段报错**Invalid JSON text: "The document is empty."** 因为mysql插入json字段的时候需要判断此字段是否为json格式
>
> 如果传输过来为空则会报错，我们将代码中设置为，为空的时候不操作这个字段，让mysql自动处理

```php
# 原代码   
$auntBasicModel->professional_scoring = !empty($professional_scoring) ? json_encode($professional_scoring) : "";//专业打分
$auntBasicModel->server_content = !empty($server_content) ? json_encode($server_content) : "";
return $auntBasicModel->save();
# 修改后
        if (!empty($professional_scoring)) {
            $auntBasicModel->professional_scoring = json_encode($professional_scoring);//专业打分
        }
        if (!empty($server_content)) {
            $auntBasicModel->server_content = json_encode($server_content);
        }
        return $auntBasicModel->save();
```

## 查询分割字符串的问题

> 如下图的**arg_id_string**字段我只有其中的某一个id想要查出此id所在的示例
>
> **使用函数FIND_IN_SET(s1,s2)**
>
> 返回字符串 c 在指定字符串中的位置，查询到这个实例直接返回即可不要管位置

**参考资料**

| 名称       | 地址                                                         |
| ---------- | ------------------------------------------------------------ |
| 第三方博客 | [link](https://wenku.baidu.com/view/9b552e071a2e453610661ed9ad51f01dc28157c6.html) |

![1651655564(1).jpg](https://s2.loli.net/2022/05/04/KBCLlZHkwNWoJ27.png)

**代码示例**

```php
/**
 * 使用mysql的 FIND_IN_SET 可以查询出所在的行
 * 核心代码  $serviceSpecModel = ServiceSpecModel::whereRaw("FIND_IN_SET($gradeId,arg_id_string)")->find();
 */
public function getGradeList()
    {
        $arr = [];
        $gradeId = !empty($this->grade_id) ? $this->grade_id : "";
        if (empty($gradeId)) {
            return [];
        }
        $serviceSpecModel = ServiceSpecModel::whereRaw("FIND_IN_SET($gradeId,arg_id_string)")->find();
        if (empty($serviceSpecModel)) return [];
        $argIds = !empty($serviceSpecModel->arg_id_string) ? explode(',', $serviceSpecModel->arg_id_string) : "";
        $argNames = !empty($serviceSpecModel->arg_name_string) ? explode(',', $serviceSpecModel->arg_name_string) : "";
        if (empty($argIds)) return [];
        foreach ($argIds as $key => $value) {
            $arr[$key] = ['id'=>$argIds[$key], 'name'=>$argNames[$key]];
        }
        return $arr;
    }
```

## **GROUP BY 分组之后如何补充缺失的日期**

**参考资料**

| 名称                  | 地址                                                         |
| --------------------- | ------------------------------------------------------------ |
| 第三方博客            | [link](https://www.ancii.com/ankwpdeau/)  [link](https://juejin.cn/post/6995003591807221767) [link](https://blog.csdn.net/AJian759447583/article/details/61421399?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-61421399-blog-120849329.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-61421399-blog-120849329.pc_relevant_antiscanv2&utm_relevant_index=1) [link](https://blog.csdn.net/qq_35788725/article/details/80626296?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-80626296-blog-120849329.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-80626296-blog-120849329.pc_relevant_antiscanv2&utm_relevant_index=6) [link](https://blog.csdn.net/u014270696/article/details/100018095?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-100018095-blog-80626296.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-100018095-blog-80626296.pc_relevant_antiscanv2&utm_relevant_index=1)  [link](https://learnku.com/articles/55484)  [link](https://please.blog.csdn.net/article/details/98487256?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-4.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-4.no_search_link) |
| PHP 求2个日期相差天数 | [link](https://baijiahao.baidu.com/s?id=1671022650633538567&wfr=spider&for=pc) |
| laravel 执行原生语句  | [link](https://blog.csdn.net/weixin_30311179/article/details/113395474) |

**代码示例**

> 先制造一个临时表储存区间日期,然后用临时表左连接主表，即可实现

```php
        $dateName = "created_at";
        $start_time = "2022-03-30";//开始日期可配置话
        $end_time = "2022-05-5";//结束日期可配置话
        //dd(date('Y-m-d',strtotime("+489 day",strtotime($start_time))));
        $earlier = new \DateTime($start_time);
        $later = new \DateTime($end_time);
        $diff = $later->diff($earlier)->format("%a");//计算开始日期到结束日期的时间差集天数
        //dd($diff);
        $firstSql = "SELECT DATE('$start_time') AS $dateName UNION ALL";
        $addSql = "";

          while (($i = $diff--) > 0) {
            $serialData = date('Y-m-d', strtotime("+1 day", strtotime($end_time)));
            //最后一行
            if ($i == 1) $addSql .= "SELECT date_sub(DATE('$serialData'), interval $i day) as $dateName";
            //非最后一行
            if ($i >1) $addSql .= "SELECT date_sub(DATE('$serialData'), interval $i day) as $dateName union all" . " ";
        }

//        for ($i = 1; $i < $diff; $i++) {
//            if ($i == $diff - 1) {
//                $addSql .= "SELECT date_sub(DATE('$end_time'), interval $i day) as $dateName";
//            } else {
//                $plus_one_end_time = $date = date('Y-m-d', strtotime("+1day", strtotime($end_time)));
//                $addSql .= "SELECT date_sub(DATE('$plus_one_end_time'), interval $i day) as $dateName union all" . " ";
//                $addSql .= "SELECT date_sub(DATE('$end_time'), interval $i day) as $dateName union all" . " ";
//            }
//        }
        $temp_table = "$firstSql $addSql ORDER BY $dateName asc";
        //var_dump($temp_table);
        # laravel 实现语法
        $query = DB::table(\DB::raw('(' . $temp_table . ') as temp_table'));//生成表
        
        // https://www.thinkphp.cn/topic/57862.html      请将 配置文件的database.php // 数据集返回类型(修改为集合返回) 'resultset_type'  => 'collection',
        # thinkphp请使用 $query = DB::table('('. $temp_table .') as temp_table');//生成表(不过返回的集合是数组) 
        sql_dump();
        $res = $query
            ->select(DB::raw("temp_table.created_at,IFNULL(stu.num,0) as num"))
            ->leftJoin(DB::raw('(SELECT DATE( updated_at ) AS updated_at, count(*) AS num FROM stu GROUP BY DATE( updated_at)) as stu'),
                DB::raw("temp_table.$dateName"),
                DB::raw('stu.updated_at'))
            ->orderBy("temp_table.$dateName",'asc')
            ->get()
            ->toArray();
        dd($res);
```

**优化封装**

```php
   /**
     * 生成临时时间表
     * @param null $start_time
     * @param null $end_time
     * @return \think\db\Query
     * @throws \Exception
     */
    public function getTempDataTable($start_time = null, $end_time = null)
    {
        $dateName = "reservation_time";
        $start_time = !empty($start_time) ? $start_time : date("Y-m-d");//开始日期可配置话
        $end_time = !empty($end_time) ? $end_time : date("Y-m-d", strtotime('+6 day'));//结束日期可配置话
        $earlier = new \DateTime($start_time);
        $later = new \DateTime($end_time);
        $diff = $later->diff($earlier)->format("%a");//计算开始日期到结束日期的时间差集天数
        if ($start_time == $end_time) $diff = 1;
        $firstSql = "SELECT DATE('$start_time') AS $dateName";
        $addSql = "";
        while (($i = $diff--) > 0) {
            $serialData = date('Y-m-d', strtotime("+1 day", strtotime($end_time)));
            if ($i == 1) $addSql .= "SELECT date_sub(DATE('$serialData'), interval $i day) as $dateName"; //最后一行
            if ($i > 1) $addSql .= "SELECT date_sub(DATE('$serialData'), interval $i day) as $dateName union all" . " "; //非最后一行
        }
        # 兼容日期是同一天时间下的构建日期
        if ($start_time == $end_time) $temp_table = "$firstSql";
        if ($start_time != $end_time) $temp_table = "$firstSql UNION ALL $addSql ORDER BY $dateName asc";
        $query = DB::table('(' . $temp_table . ') as temp_table');//生成表
        return $query;
    }
```



##  **in查询之后如何跟进in的字段顺序排序**

| 资料       | 地址                                                         |
| ---------- | ------------------------------------------------------------ |
| 第三方博客 | [link](https://www.php.cn/mysql-tutorials-487882.html) [link](https://wenku.baidu.com/view/90eba7e088d63186bceb19e8b8f67c1cfad6ee05.html) |

> 如下图所示我们想查询**22**还有**21** 两条数据 于是使用**in**查询 

<img src="https://s2.loli.net/2022/05/24/H2F1DziMjOLTtmE.png" alt="1653361601(1).png" style="zoom:50%;" />

> 可以看见是查询出来了但是结果不是我们想要的我们的需求是**查询出来的列表同in查询中的id顺序**

<img src="https://s2.loli.net/2022/05/24/6pmqwQsBNRneD7K.png" alt="1653361796(1).png" style="zoom: 67%;" />



**解决方案**

```php
# 1
# 采用 ORDER BY field('要排序的字段主键',同in中的id逗号分割) 实现 
SELECT * FROM `pxs_service_spec` where id IN (22,19,21) ORDER BY field(id,22,19,21)
# thinkphp代码示例
ServiceSpecModel::whereIn("id", $specArrId)->orderField('id',$specArrId);
```

## 查询为零(0)的数据记录

> 开发过程中因为有可能接手别人写的代码，一般数据库中的某种状态有的人喜欢用**0**代替，我们都知道判断查询条件时候外层
>
> 需要有一个为空判断一般情况下我们喜欢用php的**empty()或者isset()**函数去判断,这两个函数有个坑就是为**空或者0**的条件也会返回**真**,
>
> 但是为空情况下我们不希望查询,为0的情况下再查询,这时候就很难受了，所以这里我采用php7的**??**条件判断空(这里为**0**也会返回**0**),为了更安全
>
> 第二步骤我也做了一层判断是否是在返回规定的状态数组之内绝对安全
>
> **最好的解决方案**
>
> 设计数据库状态的时候千万不要用**0**这个状态。例如禁用状态你可以用负数**-1**,

```php
 $status = $searchParams['status'] ?? "";
 $status = $status != null && in_array($status, PositionModel::getStatusIds()) ? $searchParams['status'] : "";
 # 查询条件可以这样写
 if ($status != null) {
       $query->where('status', $status);
  }
```

## 更好的判断方法

> 像下面一个简单的方法 用<font color='red'>==</font> 双等于号强制判断类型

```shell
 public static function isZero($num = null)
    {
         if ($num !== null&&num==0) return true;
         return false;
    }    
```



## 日期时间查询

### 数据库日期是**Unix 时间戳**查询

**thinkphp解决代码示例**

> 碰到了那种不是查询日期区间的情况，只能是模糊查询到月或者具体时间

```php
# orm代码示例
$create_time = !empty($searchParamsArr['create_time']) ? trim($searchParamsArr['create_time']) : "";//操作日期
if (!empty($create_time)) {
      $query->where("FROM_UNIXTIME(create_time) like '%$create_time%'");
 }
# 对应原生语句
SELECT
	* 
FROM
	`pxs_action_log` 
WHERE
	( FROM_UNIXTIME(create_time) LIKE '%2022-05-27%' ) 
ORDER BY
	`create_time` DESC 
	LIMIT 100
```

## [mysql中如何根据一个表中的字段值，批量修改另一个表中的字段值](https://www.cnblogs.com/eliwang/p/16016887.html)

```shell
update a inner join b on a.num = b.num set a.num_id = b.id;
```

##  [mysql重置自增主键ID重置](http://www.yonomo.com/2022/0507/mysql%E8%87%AA%E5%A2%9E%E4%B8%BB%E9%94%AEid%E9%87%8D%E7%BD%AE.html)

```mysql
# 修改自增主键的起始值
alter table table_name auto_increment = 起始值
```

##  count 函数中如何添加判断条件

[**参考资料**](https://huaweicloud.csdn.net/633564a3d3efff3090b55505.html?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~activity-3-120747237-blog-128164850.pc_relevant_default&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~activity-3-120747237-blog-128164850.pc_relevant_default)

```sql
public function getFixPackageYearList($data)
    {
        $auntId = $this->aunt_id;
        $limit = !empty($data['limit']) ? $data['limit'] : PaginateService::LIMIT_DEFAULT;


        $orderReserveAuntsQueryOne = OrderReserveAuntModel::STATUS_INAPPROPRIATE;//不合适
        $orderReserveAuntsQueryTWO = OrderReserveAuntModel::STATUS_UP_HOUSEHOLDS;//上户
        # 条件查询待服务&服务中的条件
        /**
         * surplus_num 剩余次数(剩余总次数=该阿姨被预约固定排期总次数-已服务次数)
         */

        $list = OrderReserveRuleModel::alias('orr')
            ->field(
                "o.id as order_id,CONCAT(o.user_name,',',o.phone) as user_info,o.number"
                . ',' .
                "orr.fixed_date_rule"
                . ',' .
                "osa.aunt_reserve_num"
                . ',' .
                "(IFNULL(osa.aunt_reserve_num-osa.aunt_use_reserve_num,0)) as surplus_num,osa.aunt_use_reserve_num"
            )
            ->distinct('o.order_id')
            ->where('o.status', '>', OrderModel::STATUS_CLOSED) //订单没有关闭
            ->where('osa.aunt_id', $auntId) //查询自己的预约
            ->leftJoin('pxs_order o', 'o.id=orr.order_id')
            -- 这里计算了count(中计算了if条件)
            ->leftJoin(Db::raw("(select count(*) as aunt_reserve_num, count(if(status >= $orderReserveAuntsQueryTWO,1,null)) as aunt_use_reserve_num,order_id,aunt_id,status from `pxs_order_reserve_aunts`
             where status >= $orderReserveAuntsQueryOne GROUP BY order_id,aunt_id) AS osa"),
                "osa.order_id = o.id")
            ->paginate($limit);

        if (!empty($list)) $list->getCollection()->map(function ($list) {
            $list->fixed_date_rule_text = ServiceOrderInfoModel::getFixedDateRuleArr($list->fixed_date_rule);
            return $list;
        });
        PaginateService::appendResponseData($list);
        return $list;
    }
```

## where 条件如何查询自定义的select指定字段

> 直接上代码把

```php
 public function getFixPackageYearList($data)
    {
        $auntId = $this->aunt_id;
        $limit = !empty($data['limit']) ? $data['limit'] : PaginateService::LIMIT_DEFAULT;


        $orderReserveAuntsQueryOne = OrderReserveAuntModel::STATUS_INAPPROPRIATE;//不合适
        $orderReserveAuntsQueryTWO = OrderReserveAuntModel::STATUS_UP_HOUSEHOLDS;//上户
        # 条件查询待服务&服务中的条件
        /**
         * surplus_num 剩余次数(剩余总次数=该阿姨被预约固定排期总次数-已服务次数)
         */


        $surplus_num_sql = "IFNULL(osa.aunt_reserve_num-osa.aunt_use_reserve_num,0)"; //写一个公用sql直接下面条用sql查询你的条件即可

        $list = OrderReserveRuleModel::alias('orr')
            ->field(
                "o.id as order_id,CONCAT(o.user_name,',',o.phone) as user_info,o.number"
                . ',' .
                "orr.fixed_date_rule"
                . ',' .
                "osa.aunt_reserve_num"
                . ',' .
                "($surplus_num_sql) as surplus_num,osa.aunt_use_reserve_num"
            )
            ->distinct('o.order_id')
            //包年不查询固定排期规则为灵活预约的数据
            ->where('orr.fixed_date_rule', '<>', OrderReserveRuleModel::FIXED_DATE_RULE_FLEXIBLE_BOOKING)
            ->where('o.status', '>', OrderModel::STATUS_CLOSED) //订单没有关闭
            ->where('osa.aunt_id', $auntId) //查询自己的预约
            ->whereRaw("$surplus_num_sql > 0") //只查询大于0的数据
            ->leftJoin('pxs_order o', 'o.id=orr.order_id')
            ->leftJoin(Db::raw("(select count(*) as aunt_reserve_num, count(if(status >= $orderReserveAuntsQueryTWO,1,null))
             as aunt_use_reserve_num,order_id,aunt_id,status from `pxs_order_reserve_aunts`
             where status >= $orderReserveAuntsQueryOne GROUP BY order_id,aunt_id) AS osa"),
                "osa.order_id = o.id")
            ->paginate($limit);

        if (!empty($list)) $list->getCollection()->map(function ($list) {
            $list->fixed_date_rule_text = ServiceOrderInfoModel::getFixedDateRuleArr($list->fixed_date_rule);
            return $list;
        });
        PaginateService::appendResponseData($list);
        return $list;
    }
```

## 两张表的数据连接在一张表中使用 unionAll

> 使用**unionAll** 连接 
>
> 注意事项:
>
> 两张表的选择字段一定要一致才行

```php
 public function getTotalOrders($data)
    {
        $aunt_id = $this->aunt_id;//阿姨id
        $query_arr = [1 => 'current_month', 2 => 'last_month']; //需要查询的月份序列化数组写死
        $type = !empty(trim($data['type'])) ? $data['type'] : 1;
        if (!in_array($type, array_keys($query_arr))) throw new SystemException("需要查询的考勤月份不准确");
        $type = $query_arr[$type];
        $limit = !empty($data['limit']) ? $data['limit'] : PaginateService::LIMIT_DEFAULT;

        switch ($type) { //转化参数
            case 'current_month': //本月
                $month_first_day = date('Y-m-01');//本月第一天
                $this_date = date('Y-m-d');//今天的年月日
                break;
            case 'last_month': //上个月
                $month_first_day = date('Y-m-01', strtotime('-1 month'));//上个月第一天
                $this_date = date('Y-m-t', strtotime('-1 month'));//上个月的月末年月日
                break;
        }

        $getAmOrPmText = function ($start_time) {
            $time_arr = ['08:00' => '上午', '14:00' => '下午', 'default' => ''];
            return $time_arr[$start_time] ?? $time_arr['default'];
        };

        $all_fix_year_order_ids = OrderReserveRuleModel::where('fixed_date_rule', '<>', OrderReserveRuleModel::FIXED_DATE_RULE_FLEXIBLE_BOOKING)->column('order_id'); //查询所有年卡的订单id
        $all_not_in_fix_year_reserve_ids = OrderServiceReserveModel::whereNotIn('order_id', $all_fix_year_order_ids)
            ->whereBetween('reservation_time', [$month_first_day, $this_date])
            ->where('status', '>', OrderServiceReserveModel::STATUS_BEEN_CANCEL)//未取消
            ->column('id');
//        $list = OrderReserveAuntModel::alias('ora')
//            ->field("osr.id as reserve_id,osr.reservation_time,osr.start_time,osr.end_time,osr.order_id,osr.service_class,osr.service_name,osr.to_door_address")
//            ->whereIn('ora.order_service_reserve_id', $all_not_in_fix_year_reserve_ids)
//            ->where('ora.aunt_id', $aunt_id)
//            ->where('ora.status', '>=', OrderReserveAuntModel::STATUS_UP_HOUSEHOLDS)//上户
//            ->leftJoin('pxs_order_service_reserve osr', 'osr.id=ora.order_service_reserve_id')
//            ->paginate($limit);
//        if (!empty($list)) $list->getCollection()->map(function ($list) use ($getAmOrPmText) {
//            $list->service_class_text = ServiceOrderInfoModel::getServiceClassArr($list->service_class);
//            $list->time_serialize = $list->reservation_time . $getAmOrPmText($list->start_time) . $list->start_time . '-' . $list->end_time;
//            return $list;
//        });
//        PaginateService::appendResponseData($list);
//        return $list;


        $list_query = OrderReserveAuntModel::alias('ora')
            ->field("osr.id as reserve_id,osr.reservation_time,osr.start_time,osr.end_time,osr.order_id,osr.service_class,osr.service_name,osr.to_door_address")
            ->whereIn('ora.order_service_reserve_id', $all_not_in_fix_year_reserve_ids)
            ->where('ora.aunt_id', $aunt_id)
            ->where('ora.status', '>=', OrderReserveAuntModel::STATUS_UP_HOUSEHOLDS)//上户
            ->leftJoin('pxs_order_service_reserve osr', 'osr.id=ora.order_service_reserve_id');

        $list_two_query = ReserveWithAuntsModel::alias('rwa')
            ->field("osr.id as reserve_id,osr.reservation_time,osr.start_time,osr.end_time,osr.order_id,osr.service_class,osr.service_name,osr.to_door_address")
            ->whereIn('rwa.order_service_reserve_id', $all_not_in_fix_year_reserve_ids)
            ->where('rwa.aunt_id', $aunt_id)
            ->where('rwa.status', '>=', OrderReserveAuntModel::STATUS_UP_HOUSEHOLDS)//上户
            ->leftJoin('pxs_order_service_reserve osr', 'osr.id=rwa.order_service_reserve_id');


        $query = $list_query->unionAll($list_two_query->buildSql());

        $list = Db::table($query->buildSql())->alias('t')->paginate($limit);

        if (!empty($list)) $list->getCollection()->each(function ($list) use ($getAmOrPmText) {
            $list['service_class_text'] = ServiceOrderInfoModel::getServiceClassArr($list['service_class']);
            $list['time_serialize'] = $list['reservation_time'] . $getAmOrPmText($list['start_time']) . $list['start_time'] . '-' . $list['end_time'];
            return $list;
        });
        PaginateService::appendResponseData($list);
        return $list;
    }
```

##  如何查询某多个列表中的包含的单个字段的最后一条数据

```mysql
# 假设你的数据表结构如下：

CREATE TABLE my_table (
  id INT AUTO_INCREMENT PRIMARY KEY,
  col1 VARCHAR(50),
  col2 VARCHAR(50),
  col3 VARCHAR(50),
  col4 VARCHAR(50)
);

# 下面是一个实现这个需求的SQL语句：

SELECT t1.*
FROM my_table t1
JOIN (
  SELECT MAX(id) AS max_id
  FROM my_table
  WHERE col1 IN (1,2,3,4) 
  GROUP BY col1
) AS t2
ON t1.id = t2.max_id
```



# [有空要研究的mysql](https://www.begtut.com/mysql/mysql-tutorial.html)

