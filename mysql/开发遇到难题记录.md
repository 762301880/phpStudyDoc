

##  leftjoin   之后如何获取最后一条数据

> 我们经常需要连表查询一些数据但是当A表(用户信息表一个用户只有一条信息)连接B表
>
> (文章表一个用户可以有多个文章), 时候**leftJoin** 会发现产生了很多条A表数据,因为B表重复
>
> 但是我们只想要一条B表数据(及文章表**B表**)最后一篇文章	

**参考资料**

| 名称       | 地址                                                         |
| ---------- | ------------------------------------------------------------ |
| 第三方博客 | [link](https://blog.csdn.net/weixin_33117513/article/details/113265284?spm=1001.2101.3001.6650.13&utm_medium=distribute.wap_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-13.wap_blog_relevant_default&depth_1-utm_source=distribute.wap_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-13.wap_blog_relevant_default) |
|            |                                                              |

**sql示例**

**学生表**

![image-20220124081745490](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20220124081745490.png)

**文章表**

![image-20220124082054321](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20220124082054321.png)

> 需求就是,我要获取一个学生的发布的最后一片文章的名称还有**click**点击数,如果要获取最新的一条把**MAX()**函数修改为**MIN()**函数即可
>
> ，本来我从网上找的 any_value()函数也是可以实现第一条获取,没有这个好扩展

![image-20220124082702007](https://yaoliuyang-blog-images.oss-cn-beijing.aliyuncs.com/blogImages/image-20220124082702007.png)

> 运用子查询 先查询符合条件的id，再下一步
>
> 一般在子查询中，程序先运行在嵌套在最内层的语句，再运行外层。因此在写子查询语句时，可以先测试下内层的子查询语句是否输出了想要的内容，再一层层往外测试，增加子查询正确率。否则多层的嵌套使语句可读性很低。

```sql
# 代码示例 
SELECT
	* 
FROM
	`stu`
	LEFT JOIN (
	SELECT
		* 
	FROM
		article 
WHERE
	id IN ( SELECT MAX( id ) FROM article GROUP BY stu_id )) AS article ON stu.id = article.stu_id
#  选取个别字段

# 其他项目中的代码示例(laravel写法)
 $query->leftJoin(\DB::raw('(select *  from  hr_user_follows where id in (select max(id) from hr_user_follows GROUP BY user_id)) AS follows'), \DB::raw('follows.user_id'), \DB::raw('user.id'));
```

## [mysql 按照姓名排序](https://blog.csdn.net/weixin_33037089/article/details/113612181)

> 突发奇想如果有一天我需要做一个项目要按照姓式 排序怎么办，例如  **阿华,张三,王五,阿斌,张心儿** 这种排序出来
>
> **阿华,阿斌,王五,张三,张心儿** 这种排序出来,一开始我还没做的时候想的是是不是要把mysql中的读取的字符转化为
>
> 英文首字母大小写排序或者用第三方的扩展包转化为拼音排序,万事不懂先百度,人家mysql贴心自带了这种排序所以
>
> 不需要我们想的太复杂

**sql数据结构**

![stu.png](https://s2.loli.net/2022/03/13/QbinyGkERLUC4j7.png)

**对应sql**

```mysql
# 第一种排序 推荐          
# CONVERT(name USING gbk)函数将字符串 name 的字符集变成 gbk,函数查看 https://www.runoob.com/mysql/mysql-functions.html

SELECT * FROM `stu` ORDER BY CONVERT(sname USING gbk)  # 正序排列 a 字母名称在最开始

SELECT * FROM `stu` ORDER BY CONVERT(sname USING gbk) desc  # 倒序排列 z 字母名称在最开始

# 第二种排序
SELECT * FROM `stu` ORDER BY sname asc # 正序排列 a 字母名称在最开始

SELECT * FROM `stu` ORDER BY sname desc # 倒序排列 z 字母名称在最开始
```

##  **关于json字段插入数据不能为空的问题**

> 插入字段报错**Invalid JSON text: "The document is empty."** 因为mysql插入json字段的时候需要判断此字段是否为json格式
>
> 如果传输过来为空则会报错，我们将代码中设置为，为空的时候不操作这个字段，让mysql自动处理

```php
# 原代码   
$auntBasicModel->professional_scoring = !empty($professional_scoring) ? json_encode($professional_scoring) : "";//专业打分
$auntBasicModel->server_content = !empty($server_content) ? json_encode($server_content) : "";
return $auntBasicModel->save();
# 修改后
        if (!empty($professional_scoring)) {
            $auntBasicModel->professional_scoring = json_encode($professional_scoring);//专业打分
        }
        if (!empty($server_content)) {
            $auntBasicModel->server_content = json_encode($server_content);
        }
        return $auntBasicModel->save();
```

## 查询分割字符串的问题

> 如下图的**arg_id_string**字段我只有其中的某一个id想要查出此id所在的示例
>
> **使用函数FIND_IN_SET(s1,s2)**
>
> 返回字符串 c 在指定字符串中的位置，查询到这个实例直接返回即可不要管位置

**参考资料**

| 名称       | 地址                                                         |
| ---------- | ------------------------------------------------------------ |
| 第三方博客 | [link](https://wenku.baidu.com/view/9b552e071a2e453610661ed9ad51f01dc28157c6.html) |

![1651655564(1).jpg](https://s2.loli.net/2022/05/04/KBCLlZHkwNWoJ27.png)

**代码示例**

```php
/**
 * 使用mysql的 FIND_IN_SET 可以查询出所在的行
 * 核心代码  $serviceSpecModel = ServiceSpecModel::whereRaw("FIND_IN_SET($gradeId,arg_id_string)")->find();
 */
public function getGradeList()
    {
        $arr = [];
        $gradeId = !empty($this->grade_id) ? $this->grade_id : "";
        if (empty($gradeId)) {
            return [];
        }
        $serviceSpecModel = ServiceSpecModel::whereRaw("FIND_IN_SET($gradeId,arg_id_string)")->find();
        if (empty($serviceSpecModel)) return [];
        $argIds = !empty($serviceSpecModel->arg_id_string) ? explode(',', $serviceSpecModel->arg_id_string) : "";
        $argNames = !empty($serviceSpecModel->arg_name_string) ? explode(',', $serviceSpecModel->arg_name_string) : "";
        if (empty($argIds)) return [];
        foreach ($argIds as $key => $value) {
            $arr[$key] = ['id'=>$argIds[$key], 'name'=>$argNames[$key]];
        }
        return $arr;
    }
```

## **GROUP BY 分组之后如何补充确实的日期**

**参考资料**

| 名称                  | 地址                                                         |
| --------------------- | ------------------------------------------------------------ |
| 第三方博客            | [link](https://www.ancii.com/ankwpdeau/)  [link](https://juejin.cn/post/6995003591807221767) [link](https://blog.csdn.net/AJian759447583/article/details/61421399?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-61421399-blog-120849329.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-61421399-blog-120849329.pc_relevant_antiscanv2&utm_relevant_index=1) [link](https://blog.csdn.net/qq_35788725/article/details/80626296?spm=1001.2101.3001.6650.3&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-80626296-blog-120849329.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-3-80626296-blog-120849329.pc_relevant_antiscanv2&utm_relevant_index=6) [link](https://blog.csdn.net/u014270696/article/details/100018095?spm=1001.2101.3001.6661.1&utm_medium=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-100018095-blog-80626296.pc_relevant_antiscanv2&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2%7Edefault%7ECTRLIST%7ERate-1-100018095-blog-80626296.pc_relevant_antiscanv2&utm_relevant_index=1) |
| PHP 求2个日期相差天数 | [link](https://baijiahao.baidu.com/s?id=1671022650633538567&wfr=spider&for=pc) |
| laravel 执行原生语句  | [link](https://blog.csdn.net/weixin_30311179/article/details/113395474) |

**代码示例**

> 先制造一个临时表储存区间日期,然后用临时表左连接主表，即可实现

```php
        $dateName = "created_at";
        $start_time = "2022-03-30";//开始日期可配置话
        $end_time = "2022-05-5";//结束日期可配置话
        //dd(date('Y-m-d',strtotime("+489 day",strtotime($start_time))));
        $earlier = new \DateTime($start_time);
        $later = new \DateTime($end_time);
        $diff = $later->diff($earlier)->format("%a");//计算开始日期到结束日期的时间差集天数
        //dd($diff);
        $firstSql = "SELECT DATE('$start_time') AS $dateName UNION ALL";
        $addSql = "";
        for ($i = 1; $i < $diff; $i++) {
            if ($i == $diff - 1) {
                $addSql .= "SELECT date_sub(DATE('$end_time'), interval $i day) as $dateName";
            } else {
                $plus_one_end_time = $date = date('Y-m-d', strtotime("+1day", strtotime($end_time)));
                $addSql .= "SELECT date_sub(DATE('$plus_one_end_time'), interval $i day) as $dateName union all" . " ";
                $addSql .= "SELECT date_sub(DATE('$end_time'), interval $i day) as $dateName union all" . " ";
            }

        }
        $temp_table = "$firstSql $addSql ORDER BY $dateName asc";
        //var_dump($temp_table);
        # laravel 实现语法
        $query = DB::table(\DB::raw('(' . $temp_table . ') as temp_table'));//生成表
        sql_dump();
        $res = $query
            ->select(DB::raw("temp_table.created_at,IFNULL(stu.num,0) as num"))
            ->leftJoin(DB::raw('(SELECT DATE( updated_at ) AS updated_at, count(*) AS num FROM stu GROUP BY DATE( updated_at)) as stu'),
                DB::raw("temp_table.$dateName"),
                DB::raw('stu.updated_at'))
            ->orderBy("temp_table.$dateName",'asc')
            ->get()
            ->toArray();
        dd($res);
```

# [有空要研究的mysql](https://www.begtut.com/mysql/mysql-tutorial.html)

