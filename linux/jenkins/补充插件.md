## [Publish Over SSH](https://plugins.jenkins.io/publish-over-ssh)  å‘å¸ƒä»£ç 

**èµ„æ–™**

| åç§°         | åœ°å€                                                         |
| ------------ | ------------------------------------------------------------ |
| ç½‘ç»œåšå®¢     | [linuxåˆ›å»ºæ–°ç”¨æˆ·å¹¶é‡‡ç”¨sshå¯†åŒ™ç™»å½•](https://gitee.com/yaolliuyang/phpStudyDoc/blob/main/linux/centOs/linux%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7%E5%B9%B6%E9%87%87%E7%94%A8ssh%E5%AF%86%E5%8C%99%E7%99%BB%E5%BD%95.md) |
| æ’ä»¶è¯´æ˜å®˜ç½‘ | [link](https://plugins.jenkins.io/publish-over-ssh/)         |
| æ’ä»¶ä½¿ç”¨å‚è€ƒ | [link](http://www.jiajiajia.club/blog/artical/pejehb2iwosl/512) |

**è¯´æ˜**

> é¦–å…ˆæˆ‘ä»¬è¦ä¿è¯æˆ‘ä»¬çš„æœåŠ¡å™¨å¯ä»¥é€šè¿‡sshå¯†é’¥ç™»å½•æ‰è¡Œï¼Œä¸ä¼šçš„è¯å¯ä»¥çœ‹æˆ‘ä¸Šé¢çš„[å‚è€ƒèµ„æ–™](https://gitee.com/yaolliuyang/phpStudyDoc/blob/main/linux/centOs/linux%E5%88%9B%E5%BB%BA%E6%96%B0%E7%94%A8%E6%88%B7%E5%B9%B6%E9%87%87%E7%94%A8ssh%E5%AF%86%E5%8C%99%E7%99%BB%E5%BD%95.md)

### é…ç½®publish over ssh

**ä¸‹è½½æ’ä»¶**

> **ç³»ç»Ÿç®¡ç†->æ’ä»¶ç®¡ç†->å¯é€‰æ’ä»¶**  æœç´¢ **<font color='#6fa8dc'>Publish Over SSH</font>**
>
> ç‚¹å‡»å®‰è£…é‡å¯

![image-20220726145930524](https://gitee.com/yaolliuyang/blogImages/raw/master/blogImages/image-20220726145930524.png)



**jenkins ssh keyé…ç½®**

> è¿™å°†é…ç½®æ‰€æœ‰ SSH é…ç½®å°†ä½¿ç”¨çš„é»˜è®¤å¯†é’¥ã€‚
> é…ç½®å¯†é’¥çš„æœ€ç®€å•æ–¹æ³•æ˜¯å°†æœªåŠ å¯†çš„å¯†é’¥ç²˜è´´åˆ°å¯†é’¥æ¡†ä¸­ã€‚
> è¦è¿›è¡Œé…ç½®ï¼Œè¯·å°†è·¯å¾„è®¾ç½®**ä¸º**åŒ…å«å¯†é’¥çš„æ–‡ä»¶**æˆ–**å°†å¯†é’¥ç²˜è´´åˆ°å¯†é’¥å­—æ®µä¸­ã€‚
> å¦‚æœåŒæ—¶åœ¨ Path to key å’Œ Key ä¸­è¾“å…¥æ•°æ®ï¼Œåˆ™ç²˜è´´çš„ Key å°†ä¼˜å…ˆï¼Œè€Œ Path to file å°†è¢«å¿½ç•¥ã€‚
>
> è¿™äº›è®¾ç½®é»˜è®¤ç”¨äºæ‰€æœ‰ä¸»æœºã€‚
>
> #### æœªåŠ å¯†çš„å¯†é’¥
>
> å¦‚æœæ‚¨æ‰“ç®—å°† Jenkins é…ç½®é¡µé¢çš„è¯»å–æƒé™æˆäºˆéç®¡ç†å‘˜ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥ç¡®ä¿æ‚¨åªä½¿ç”¨ä½¿ç”¨å¼ºå¯†ç åŠ å¯†çš„ç§é’¥ã€‚
> passphrase æœ¬èº«åœ¨ä¿å­˜é…ç½®æ—¶ä¼šè¢«åŠ å¯†ï¼Œåœ¨ UI ä¸­ä¹Ÿä¼šè¢«åŠ å¯†ï¼Œæ— æ³•è¯»å–å€¼ã€‚
>
> #### å¯†ç 
>
> å¦‚æœå¯†é’¥ä½¿ç”¨å¯†ç åŠ å¯†ï¼Œåˆ™åœ¨æ­¤å¤„è®¾ç½®ã€‚
>
> #### æ–‡ä»¶è·¯å¾„
>
> è¦ä½¿ç”¨çš„ç§æœ‰ SSH å¯†é’¥åœ¨ Jenkins ä¸»æœåŠ¡å™¨ä¸Šçš„ä½ç½®ã€‚
> è¯¥è·¯å¾„å¯ä»¥æ˜¯å¯†é’¥çš„ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äº JENKINS_HOME ç›®å½•çš„è·¯å¾„ã€‚
>
> #### é’¥åŒ™
>
> å°†ç§é’¥ç²˜è´´åˆ°æ­¤æ¡†ä¸­ã€‚
> é”®åº”åŒ…æ‹¬é¡µçœ‰å’Œé¡µè„š (----) ä»¥åŠå…¶é—´çš„æ‰€æœ‰å†…å®¹ã€‚
>
> #### ç¦ç”¨æ‰§è¡Œ
>
> æ­¤é€‰é¡¹å°†åˆ é™¤ä»æ­¤æ’ä»¶æ‰§è¡Œå‘½ä»¤çš„èƒ½åŠ›ã€‚
> å¦‚æœé€‰ä¸­æ­¤é€‰é¡¹ï¼Œåˆ™ SSH æœåŠ¡å™¨çš„ Advanced éƒ¨åˆ†ä¸­çš„ Disable exec é€‰é¡¹å°†è¢«å¿½ç•¥

![image-20220726150540993](https://gitee.com/yaolliuyang/blogImages/raw/master/blogImages/image-20220726150540993.png)

**SSH Serveré…ç½®**

> name:å¯ä»¥è‡ªå®šä¹‰æœ€å¥½ä¸è¦ä½¿ç”¨ä¸­æ–‡(ä¼šè½¬ä¹‰)
>
> hostname:ipåœ°å€
>
> username:ç™»å½•æœåŠ¡å™¨çš„ç”¨æˆ·
>
> Remote Directory:è¿œç¨‹ç›®å½•è¿™é‡Œå¡«å†™æ ¹ç›®å½•å³å¯(/)  

![image-20220726150758902](https://gitee.com/yaolliuyang/blogImages/raw/master/blogImages/image-20220726150758902.png)

### é¡¹ç›®ä¸­ä½¿ç”¨

> å¢åŠ æ„å»ºæ­¥éª¤ä¸­é€‰æ‹©å¹¶å¡«å†™æ‰§è¡Œå‘½ä»¤å³å¯æ„å»ºé¡¹ç›®

![image-20220726151202331](https://gitee.com/yaolliuyang/blogImages/raw/master/blogImages/image-20220726151202331.png)

##  Generic Webhook Trigger (æ’ä»¶ ç»“åˆwebhookæ„å»ºé¡¹ç›®)

> å‘ç°é«˜ç‰ˆæœ¬çš„**jenkins LTSç‰ˆæœ¬  webhookä¼šæŠ¥403é”™è¯¯**  

###  é—®é¢˜æœ¬è´¨

åœ¨é«˜ç‰ˆæœ¬ Jenkins ä¸­ï¼š

- é»˜è®¤å¯ç”¨äº† CSRF Protectionï¼ˆCrumbï¼‰
- `job/build?token=...` è¿™ç§è€å¼è§¦å‘æ–¹å¼**å·²ç»åºŸå¼ƒ**
- **æ²¡æœ‰ Crumb çš„è¯·æ±‚ä¼šè¿”å› 403**

### âœ… æ­£ç¡®ä¸”æ¨èçš„è§£å†³æ–¹æ¡ˆï¼ˆé«˜ç‰ˆæœ¬é€‚é…ï¼‰

æˆ‘ä»¬éœ€è¦æ”¹ç”¨æ”¯æŒå®‰å…¨æ ¡éªŒçš„ webhook æ¥å£ï¼Œæ¯”å¦‚ **Generic Webhook Trigger æ’ä»¶**ï¼Œæˆ–è€…ä½¿ç”¨ **Git SCM polling + webhook è§¦å‘ polling**ã€‚

------

## ğŸš€ æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ `Generic Webhook Trigger Plugin`ï¼ˆæ¨èï¼‰

### âœ… æ­¥éª¤ï¼š

#### 1. å®‰è£…æ’ä»¶

- `Manage Jenkins` â†’ `Plugins` â†’ å®‰è£… `Generic Webhook Trigger Plugin`

#### 2. åœ¨ Job ä¸­å¯ç”¨ Webhook è§¦å‘

- æ–°å»ºæˆ–ç¼–è¾‘ä¸€ä¸ª Jobï¼ˆæ¨èä½¿ç”¨ **Pipeline ç±»å‹**ï¼‰
- å‹¾é€‰ `Build Triggers` â†’ `Generic Webhook Trigger`
- é…ç½®ä¸€ä¸ª Tokenï¼Œæ¯”å¦‚ `gitcode_token`

#### 3. Jenkins ä¸­çš„ webhook URLï¼š

```
bash


å¤åˆ¶ç¼–è¾‘
http://<jenkins_host>/generic-webhook-trigger/invoke?token=gitcode_token
```

> âœ… è¿™ä¸ªæ¥å£ **é»˜è®¤ä¸èµ° CSRF æ ¡éªŒ**ï¼Œå¯ä»¥æ­£å¸¸è¢« GitCode è°ƒç”¨ã€‚

#### 4. GitCode ä»“åº“é…ç½® Webhookï¼š

- Webhook URL å°±å¡«ä¸Šé¢è¿™æ¡
- äº‹ä»¶é€‰æ‹© â€œPushâ€ æˆ–ä½ æƒ³è§¦å‘çš„ç±»å‹
- Payload ç±»å‹ï¼šJSONï¼ˆé»˜è®¤å³å¯ï¼‰

#### 5. Jenkinsfile ç¤ºä¾‹ï¼š

```
groovyå¤åˆ¶ç¼–è¾‘pipeline {
  agent any
  stages {
    stage('Pull Code') {
      steps {
        git branch: 'main', url: 'https://gitcode.com/yourname/yourrepo.git'
      }
    }
    stage('Build') {
      steps {
        sh 'npm install'
        sh 'npm run build'
      }
    }
  }
}
```

### ğŸ§  åŸç†è¯´æ˜

Generic Webhook Trigger æ’ä»¶ **è‡ªå·±å®ç°äº† webhook æ¥æ”¶ç«¯å£ï¼Œä¸ä½¿ç”¨è€çš„ `job/build?token=xxx` è·¯ç”±**ï¼Œä»è€Œç»•è¿‡äº† CSRF çš„ crumb æ ¡éªŒã€‚

### ğŸ›  è¡¥å……æŠ€å·§ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ éè¦ç”¨ä¼ ç»Ÿçš„ `build?token=...` æ¥å£ï¼Œä»å¯ä»¥ä½¿ç”¨ä¸‹åˆ—æ–¹æ³•ï¼ˆæ›´å¤æ‚ï¼‰ï¼š

### æ–¹å¼ï¼šç”¨è„šæœ¬è·å– Crumbï¼Œæ„é€ è¯·æ±‚ï¼ˆä¸æ¨è GitCode ç”¨ï¼‰

```
bashå¤åˆ¶ç¼–è¾‘CRUMB=$(curl -s -u user:apitoken 'http://jenkins/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)')
curl -X POST -u user:apitoken -H "$CRUMB" http://jenkins/job/your-job-name/build
```

ä½†è¿™ç§æ–¹å¼ä¸é€‚ç”¨äº GitCode çš„ Webhookï¼Œå› ä¸º GitCode æ²¡æ³•å…ˆå‘è¯·æ±‚è·å– Crumbã€‚

### âœ… ç»“è®ºæ€»ç»“

| æ–¹æ¡ˆ                                | æ˜¯å¦æ”¯æŒé«˜ç‰ˆæœ¬ | å®‰å…¨ | ç®€å•åº¦ | é€‚åˆ GitCode |
| ----------------------------------- | -------------- | ---- | ------ | ------------ |
| âŒ `build?token=...` æ¥å£            | âŒ å·²åºŸå¼ƒ       | ä½   | ç®€å•   | å¦           |
| âœ… `Generic Webhook Trigger` æ’ä»¶    | âœ… æ”¯æŒ         | ä¸­   | âœ… æ¨è | âœ… æ”¯æŒ       |
| âœ… è®¤è¯ + API Token + Crumb æ‰‹åŠ¨æ‹¼æ¥ | âœ… æ”¯æŒ         | é«˜   | å¤æ‚   | âŒ ä¸é€‚ç”¨     |